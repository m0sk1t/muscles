angular.module("MuscleMan",["ngLocale","ui.calendar","ngFileUpload","ngRoute","720kb.datepicker","froala","Services"]).config(["$routeProvider","$locationProvider",function(t,e){t.when("/",{templateUrl:"tpl/main.tpl",controller:"MainCtrl"}).when("/manager/signin",{templateUrl:"tpl/manager_signin.tpl",controller:"ManagerSignInCtrl"}).when("/manage/user/:id",{templateUrl:"tpl/manage_user.tpl",controller:"ManageUserCtrl"}).when("/manage/article/:id",{templateUrl:"tpl/manage_article.tpl",controller:"ManageArticleCtrl"}).when("/manage/contest/:id",{templateUrl:"tpl/manage_contest.tpl",controller:"ManageContestCtrl"}).when("/manage/competition/:id",{templateUrl:"tpl/manage_competition.tpl",controller:"ManageCompetitionCtrl"}).when("/manager/:id",{templateUrl:"tpl/manager.tpl",controller:"ManagerCtrl"}).when("/signup",{templateUrl:"tpl/signup.tpl",controller:"SignUpCtrl"}).when("/signin",{templateUrl:"tpl/signin.tpl",controller:"SignInCtrl"}).when("/forgot",{templateUrl:"tpl/forgot.tpl",controller:"ForgotCtrl"}).when("/reset/:token",{templateUrl:"tpl/reset.tpl",controller:"ResetCtrl"}).when("/user/:userid/album/:id",{templateUrl:"tpl/album.tpl",controller:"AlbumCtrl"}).when("/hobbies",{templateUrl:"tpl/hobbies.tpl",controller:"HobbiesCtrl"}).when("/articles",{templateUrl:"tpl/articles.tpl",controller:"ArticlesCtrl"}).when("/article/:id",{templateUrl:"tpl/article.tpl",controller:"ArticleCtrl"}).when("/competitions",{templateUrl:"tpl/competitions.tpl",controller:"CompetitionsCtrl"}).when("/competition/:id",{templateUrl:"tpl/competition.tpl",controller:"CompetitionCtrl"}).when("/contests",{templateUrl:"tpl/contests.tpl",controller:"ContestsCtrl"}).when("/contest/:id",{templateUrl:"tpl/contest.tpl",controller:"ContestCtrl"}).when("/dialogs",{templateUrl:"tpl/dialogs.tpl",controller:"DialogsCtrl"}).when("/favs",{templateUrl:"tpl/favs.tpl",controller:"FavsCtrl"}).when("/user/:id/photos/:photoid",{templateUrl:"tpl/photos.tpl",controller:"PhotosCtrl"}).when("/user/:id/videos/:videoid",{templateUrl:"tpl/videos.tpl",controller:"VideosCtrl"}).when("/options/:tab",{templateUrl:"tpl/options.tpl",controller:"OptionsCtrl"}).when("/search",{templateUrl:"tpl/search.tpl",controller:"SearchCtrl"}).when("/user/:id",{templateUrl:"tpl/user.tpl",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(t){console.log("App loaded!")}]),angular.module("MuscleMan").directive("userLinksBlock",function(){return{restrict:"E",templateUrl:"tpl/directives/user-links-block.tpl"}}).directive("adsBlock",function(){return{restrict:"E",templateUrl:"tpl/directives/ads-block.tpl"}}).directive("photoSliderBlock",function(){return{restrict:"E",templateUrl:"tpl/directives/photo-slider-block.tpl"}}).directive("videoSliderBlock",function(){return{restrict:"E",templateUrl:"tpl/directives/video-slider-block.tpl"}}).directive("autocompleteBlock",["$vk",function(t){return{restrict:"E",scope:{area:"@",city:"=",onSet:"&",chair:"=",substr:"=",country:"=",faculty:"=",university:"="},templateUrl:"tpl/directives/autocomplete-block.tpl",link:function(e,n,o){e.load=function(){switch(e.area){case"country":t.get_countries(function(t){e.items=t.data},function(t){console.error(t)});break;case"city":t.get_cities({q:e.substr,country_id:e.country},function(t){e.items=t.data},function(t){console.error(t)});break;case"university":t.get_universities({q:e.substr,city_id:e.city,country_id:e.country},function(t){e.items=t.data},function(t){console.error(t)});break;case"faculty":t.get_faculties({q:e.substr,city_id:e.city,country_id:e.country,university_id:e.university},function(t){e.items=t.data},function(t){console.error(t)});break;case"chair":t.get_faculties({q:e.substr,city_id:e.city,faculty_id:e.faculty,country_id:e.country,university_id:e.university},function(t){e.items=t.data},function(t){console.error(t)})}},e.set=function(t){e.items=[],e.substr=t.title,e.onSet({item:t})}}}}]),angular.module("MuscleMan").filter("search_filter",function(){return function(t,e,n,o){var r=t.sort(function(t,n){if("rating"===e)switch(!0){case t.rating>n.rating:return 1;case t.rating<n.rating:return-1;default:return 0}if("age"===e){var o=new Date(t.birthDate).valueOf(),r=new Date(n.birthDate).valueOf();switch(!0){case o<r:return 1;case o>r:return-1;default:return 0}}});return n&&(r=r.filter(function(t){return t.sports.indexOf(n)!==-1})),o&&(r=r.filter(function(t){return t.hobbies.filter(function(t){t.item.indexOf(o)!==-1}).length})),r}}),angular.module("Services",[]).factory("User",["$http",function(t){return{get:function(e,n){return t.get("/user").then(e,n)},get_favs:function(e,n){return t.get("/favs").then(e,n)},get_hobbies:function(e,n){return t.get("/hobbies").then(e,n)},get_sports:function(e,n){return t.get("/sports").then(e,n)},get_contest:function(e,n,o){return t.get("/contest/"+e).then(n,o)},view_contest:function(e,n,o){return t.put("/contest/"+e+"/inc_view").then(n,o)},add_contest_participant:function(e,n,o){return t.put("/contest/"+e+"/add_participant").then(n,o)},add_paid_like:function(e,n,o,r){return t.put("/contest/"+e+"/add_paid_like/"+n).then(o,r)},add_free_like:function(e,n,o,r){return t.put("/contest/"+e+"/add_free_like/"+n).then(o,r)},rm_contest_participant:function(e,n,o){return t.put("/contest/"+e+"/rm_participant").then(n,o)},competition_add_comment:function(e,n,o,r){return t.put("/competition/"+e+"/add_comment",n).then(o,r)},get_competition:function(e,n,o){return t.get("/competition/"+e).then(n,o)},add_mark:function(e,n,o){return t.put("/user/add_mark/"+e.id,e).then(n,o)},rm_mark:function(e,n,o){return t.put("/user/rm_mark/"+e.id,e).then(n,o)},add_university:function(e,n,o){return t.put("/user/add_university",e).then(n,o)},rm_university:function(e,n,o){return t.put("/user/rm_university",e).then(n,o)},add_workplace:function(e,n,o){return t.put("/user/add_workplace",e).then(n,o)},rm_workplace:function(e,n,o){return t.put("/user/rm_workplace",e).then(n,o)},add_achievement:function(e,n,o){return t.put("/user/add_achievement",e).then(n,o)},rm_achievement:function(e,n,o){return t.put("/user/rm_achievement",e).then(n,o)},add_hobbie:function(e,n,o){return t.put("/user/add_hobbie",e).then(n,o)},rm_hobbie:function(e,n,o){return t.put("/user/rm_hobbie",e).then(n,o)},add_sport:function(e,n,o){return t.put("/user/add_sport",e).then(n,o)},rm_sport:function(e,n,o){return t.put("/user/rm_sport",e).then(n,o)},load:function(e,n,o){return t.get("/user/"+e).then(n,o)},set:function(e,n,o){return t.put("/user",e).then(n,o)},signup:function(e,n,o){return t.post("/signup",e).then(n,o)},signin:function(e,n,o){return t.post("/auth/local",e).then(n,o)},forgot:function(e,n,o){return t.post("/forgot",e).then(n,o)},reset:function(e,n,o){return t.post("/reset/"+e.token,e).then(n,o)},changepwd:function(e,n,o){return t.put("/changepwd",e).then(n,o)},unlink:function(e,n,o){return t.put("/unlink/"+e).then(n,o)},search:function(e,n,o){return t.post("/user/search",e).then(n,o)}}}]).factory("Manager",["$http",function(t){return{all:function(e,n){return t.get("/manager/all").then(e,n)},get:function(e,n,o){return t.get("/manager/"+e).then(n,o)},signin:function(e,n,o){return t.post("/manager/signin",e).then(n,o)},create:function(e,n,o){return t.post("/manager/new",e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/manager/"+e).then(n,o)},set_permission:function(e,n,o,r){return t.put("/manager/"+e,n).then(o,r)},create_theme:function(e,n,o){return t.post("/manage/theme",e).then(n,o)},create_article:function(e,n){return t.post("/manage/article/new",{}).then(e,n)},create_contest:function(e,n){return t.post("/manage/contest/new",{}).then(e,n)},create_competition:function(e,n){return t.post("/manage/competition/new",{}).then(e,n)},create_hobbie:function(e,n,o){return t.post("/manage/hobbie/new",e).then(n,o)},create_sport:function(e,n,o){return t.post("/manage/sport/new",e).then(n,o)},comment_article:function(e,n,o,r){return t.put("/article/"+e+"/add_comment",n).then(o,r)},update_article:function(e,n,o,r){return t.put("/manage/article/"+e,n).then(o,r)},update_contest:function(e,n,o,r){return t.put("/manage/contest/"+e,n).then(o,r)},update_competition:function(e,n,o,r){return t.put("/manage/competition/"+e,n).then(o,r)},update_hobbie:function(e,n,o,r){return t.put("/manage/hobbie/"+e,n).then(o,r)},update_sport:function(e,n,o,r){return t.put("/manage/sport/"+e,n).then(o,r)},update_user:function(e,n,o,r){return t.put("/manage/user/"+e,n).then(o,r)},get_themes:function(e,n){return t.get("/manage/themes").then(e,n)},get_article:function(e,n,o){return t.get("/manage/article/"+e).then(n,o)},get_contest:function(e,n,o){return t.get("/manage/contest/"+e).then(n,o)},get_competition:function(e,n,o){return t.get("/manage/competition/"+e).then(n,o)},get_articles:function(e,n,o){return t.get("/manage/articles/"+e).then(n,o)},get_contests:function(e,n,o){return t.get("/manage/contests/"+e).then(n,o)},get_competitions:function(e,n,o){return t.get("/manage/competitions/"+e).then(n,o)},get_hobbies:function(e,n){return t.get("/hobbies").then(e,n)},get_sports:function(e,n){return t.get("/sports").then(e,n)},get_photos:function(e,n,o){return t.get("/manage/photos/"+e).then(n,o)},get_users:function(e,n,o){return t.get("/manage/users/"+e).then(n,o)},get_videos:function(e,n,o){return t.get("/manage/videos/"+e).then(n,o)},get_topics:function(e,n,o){return t.get("/manage/topics/"+e).then(n,o)},delete_theme:function(e,n,o){return t["delete"]("/manage/theme/"+e).then(n,o)},delete_article:function(e,n,o){return t["delete"]("/manage/article/"+e).then(n,o)},delete_competition:function(e,n,o){return t["delete"]("/manage/competition/"+e).then(n,o)},delete_contest:function(e,n,o){return t["delete"]("/manage/contest/"+e).then(n,o)},delete_hobbie:function(e,n,o){return t["delete"]("/manage/hobbie/"+e).then(n,o)},delete_sport:function(e,n,o){return t["delete"]("/manage/sport/"+e).then(n,o)},delete_photo:function(e,n,o){return t["delete"]("/manage/photo/"+e).then(n,o)},delete_video:function(e,n,o){return t["delete"]("/manage/video/"+e).then(n,o)},delete_user:function(e,n,o){return t["delete"]("/manage/user/"+e).then(n,o)},delete_topic:function(e,n,o){return t["delete"]("/manage/topic/"+e).then(n,o)}}}]).factory("Dialog",["$http",function(t){return{get:function(e,n){return t.get("/dialog/all").then(e,n)},check:function(e,n,o){return t.get("/checkdlg/"+e).then(n,o)},create:function(e,n,o){return t.post("/dialog",e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/dialog/"+e).then(n,o)},add_message:function(e,n,o,r){return t.put("/dialog/"+e,n).then(o,r)}}}]).factory("$vk",["$http",function(t){return{get_countries:function(e,n){return t.post("vk/database.getCountries").then(e,n)},get_cities:function(e,n,o){return e.count=33,t.post("vk/database.getCities",e).then(n,o)},get_universities:function(e,n,o){return t.post("vk/database.getUniversities",e).then(n,o)},get_faculties:function(e,n,o){return t.post("vk/database.getFaculties",e).then(n,o)},get_chairs:function(e,n,o){return t.post("vk/database.getChairs",e).then(n,o)}}}]).factory("Topic",["$http",function(t){return{get:function(e,n,o){return t.get("/topic/"+e).then(n,o)},"new":function(e,n,o){return t.post("/topic/new",e).then(n,o)},del:function(e,n,o){return t["delete"]("/topic/"+e).then(n,o)},edit:function(e,n,o){return t.put("/topic/"+e._id,e).then(n,o)},add_like:function(e,n,o){return t.put("/topic/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/topic/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/topic/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/topic/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Photo",["$http",function(t){return{get:function(e,n,o){return t.get("/photo/"+e).then(n,o)},edit:function(e,n,o){return t.put("/photo/"+e._id,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/photo/"+e).then(n,o)},add_like:function(e,n,o){return t.put("/photo/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/photo/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/photo/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/photo/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Video",["$http",function(t){return{get:function(e,n,o){return t.get("/video/"+e).then(n,o)},add:function(e,n,o){return t.post("/video/new",e).then(n,o)},edit:function(e,n,o){return t.put("/video/"+e._id,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/video/"+e).then(n,o)},add_like:function(e,n,o){return t.put("/video/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/video/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/video/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/video/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Album",["$http",function(t){return{get:function(e,n,o){return t.get("/album/"+e).then(n,o)},get_one:function(e,n,o){return t.get("/single_album/"+e).then(n,o)},create:function(e,n,o){return t.post("/album/new",{title:e}).then(n,o)},set_title:function(e,n,o){return t.put("/album/"+e._id,e).then(n,o)},add_photo:function(e,n,o){return t.put("/album/"+e._id+"/add_photo/"+e.photoid,e).then(n,o)},remove_photo:function(e,n,o){return t.put("/album/"+e._id+"/remove_photo/"+e.photoid,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/album/"+e).then(n,o)}}}]).factory("MSG",function(){return{ok:function(t){swal("OK!",t)},info:function(t){swal("Info!",t,"info")},warn:function(t){swal("Warning!",t,"warning")},err:function(t){swal("Error!",t,"error")},custom:function(t,e){swal(t,e)}}}).factory("LS",function(){return{get:function(t){try{var t=localStorage.getItem(t);return t?JSON.parse(t):null}catch(e){return console.error(e),null}},set:function(t,e){try{var n=e?JSON.stringify(e):"";return localStorage.setItem(t,n),!0}catch(o){return localStorage.clear(),console.error(o),!1}}}}).factory("notify",function(){var t=new Audio("alarm.mp3");return{play:function(){t.play()}}}).factory("socket",["$rootScope",function(t){var e=io();return{on:function(n,o){e.on(n,function(){var n=arguments;t.$apply(function(){o.apply(e,n)})})},emit:function(n,o,r){e.emit(n,o,function(){var n=arguments;t.$apply(function(){r&&r.apply(e,n)})})}}}]),angular.module("MuscleMan").controller("AlbumCtrl",["$scope","$routeParams","Photo","Album","MSG",function(t,e,n,o,r){t.album={},t.photos=[],t.gallery={current_photo:null},t.layer={editedAlbum:null,editedPhoto:null},t.manage_photo_keypress=function(e){var n={ESCAPE:27,RIGHT:39,LEFT:37};switch(e.keyCode){case n.ESCAPE:t.gallery.current_photo=null;break;case n.RIGHT:t.turn_photo_right();break;case n.LEFT:t.turn_photo_left()}},t.getDate=function(t){return moment(t).format("DD.MM.YYYY")},t.turn_photo_left=function(){0===t.gallery.current_photo?t.gallery.current_photo=t.photos.length:t.gallery.current_photo--},t.turn_photo_right=function(){t.gallery.current_photo===t.photos.length-1?t.gallery.current_photo=0:t.gallery.current_photo++},t.edit_album=function(e){o.set_title(e,function(n){t.album.title=e.title,t.layer.editedAlbum=null,r.ok("Наименование альбома успешно изменено!")},function(t){console.error(t.data)})},t.set_album_cover=function(e){e._id=t.album._id,e.title=t.album.title,o.set_title(e,function(n){t.album.cover=e.title,t.layer.editedAlbum=null,r.ok("Обложка альбома успешно изменена!")},function(t){console.error(t.data)})},t.edit_photo=function(e){n.edit(e,function(e){t.photos=t.photos.map(function(e){return e._id===t.layer.editedPhoto._id&&(e._id=t.layer.editedPhoto._id),e}),t.layer.editedPhoto=null,r.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},t.like_photo=function(){var e=t.photos[t.gallery.current_photo].likes.indexOf(t.options.user._id);e===-1?n.add_like(t.photos[t.gallery.current_photo],function(e){t.photos[t.gallery.current_photo].likes.push(t.options.user._id)},function(t){console.error(t.data)}):n.remove_like(t.photos[t.gallery.current_photo],function(n){t.photos[t.gallery.current_photo].likes.splice(e,1)},function(t){console.error(t.data)})},t.add_photo_comment=function(){if(t.gallery.comment){var o={date:Date.now(),name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname,_id:t.photos[t.gallery.current_photo]._id};n.add_comment(o,function(n){t.gallery.comment="",t.photos[t.gallery.current_photo].comments.push(o),e.id!==t.options.user._id&&(o.target=e.id,socket.emit("photo:comment",o))},function(t){console.error(t.data)})}},t.remove_photo_comment=function(e){n.remove_comment({comment:e,_id:t.photos[t.gallery.current_photo]._id},function(n){t.photos[t.gallery.current_photo].comments=t.photos[t.gallery.current_photo].comments.filter(function(n){return!(n.userid===t.options.user._id&&n.comment===e)})},function(t){console.error(t.data)})},n.get(e.userid,function(n){t.photos=n.data.filter(function(t){return t.album===e.id})},function(t){console.error(t.data)}),o.get_one(e.id,function(e){t.album=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ArticleCtrl",["$sce","$scope","$routeParams","Manager",function(t,e,n,o){e.article={},e.location=location.href,e.format_date=function(t){return moment(t).format("DD.MM.YYYY")},o.get_article(n.id,function(t){e.article=t.data,e.meta.description=e.article.description,e.meta.keywords=e.article.keywords,e.meta.title=e.article.title},function(t){console.error(t.data)}),e.article_html=function(){return t.trustAsHtml(e.article.text)},e.add_comment=function(){o.comment_article(n.id,{comment:e.comment},function(t){e.article.comments.push({date:new Date,comment:e.comment,name:e.options.user.name,userid:e.options.user._id,avatar:e.options.user.avatar,surname:e.options.user.surname}),e.comment=""},function(t){console.error(t)})}}]),angular.module("MuscleMan").controller("ArticlesCtrl",["$scope","Manager",function(t,e){t.articles=[],t.get_picture=function(e){var n=t.articles[e].text.match(/src="[\w\:\\"\/\.\d-_]+"/);if(n&&n.length)return n[0]=n[0].replace('src="',""),n[0]=n[0].replace('"',""),n[0]},e.get_themes(function(e){t.themes=e.data},function(t){console.error(t.data)}),e.get_sports(function(e){t.sports=e.data},function(t){console.error(t.data)}),t.format_date=function(t){return moment(t).format("DD.MM.YYYY")},e.get_articles(Date.now(),function(e){t.articles=e.data},function(t){console.error(t)})}]),angular.module("MuscleMan").controller("CompetitionCtrl",["$scope","$routeParams","User",function(t,e,n){t.location=location.href,t.competition={},t.add_comment=function(){t.comment&&n.competition_add_comment(e.id,{comment:t.comment},function(e){t.competition.comments.push({date:new Date,comment:t.comment,name:t.options.user.name,avatar:t.options.user.avatar,surname:t.options.user.surname}),t.comment=""},function(t){console.error(t)})},t.format_date=function(t){return moment(t).format("DD.MM.YYYY")},n.get_competition(e.id,function(e){t.competition=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("CompetitionsCtrl",["$scope","User","uiCalendarConfig","Manager",function(t,e,n,o){t.calendarOptions={eventClick:function(t,e,n){location.hash="#/competition/"+t._id}},o.get_sports(function(e){t.sports=e.data},function(t){console.error(t)}),t.change_view=function(t,e){n.calendars[e].fullCalendar("changeView",t)},t.eventSources={url:"/competition/all"}}]),angular.module("MuscleMan").controller("ContestCtrl",["$scope","$routeParams","User","MSG",function(t,e,n,o){var r=e.id;t.type="",t.contest={},n.view_contest(r,function(t){},function(t){console.error(t)}),n.get_contest(r,function(e){t.contest=e.data;var n=moment.utc(moment(t.contest.dateEnd).diff(moment(Date.now()))).format("DD:HH:mm").split(":");t.estimate_days=n[0].match(/\d/g),t.estimate_hours=n[1].match(/\d/g),t.estimate_minutes=n[2].match(/\d/g)},function(t){console.error(t.data)}),t.expired=function(){return moment(t.contest.dateParticipate).diff(Date.now(),"days")},t.count_free_likes=function(){var e=0;return t.contest.participants&&t.contest.participants.map(function(t){e+=t.likes.free.length}),e},t.count_paid_likes=function(){var e=0;return t.contest.participants&&t.contest.participants.map(function(t){e+=t.likes.paid.length}),e},t.count_new_participants=function(){var e=moment.now();if(t.contest.participants)return t.contest.participants.filter(function(t){return 1===moment(t.pDate).diff(e,"days")}).length},t.add_paid_like=function(e){n.add_paid_like(r,e,function(e){t.contest=e.data},function(t){o.err(t.data),console.error(t.data)})},t.add_free_like=function(e){n.add_free_like(r,e,function(e){t.contest=e.data},function(t){o.err(t.data),console.error(t.data)})},t.may_participate=function(){if(t.contest.participants)return!t.contest.participants.filter(function(e){return e.id===t.options.user._id}).length},t.participate=function(){t.contest.participants&&(t.contest.participants.filter(function(e){return e.id===t.options.user._id}).length?n.rm_contest_participant(r,function(e){t.contest.participants=t.contest.participants.filter(function(e){return e.id!==t.options.user._id})},function(t){console.error(t.data)}):n.add_contest_participant(r,function(e){t.contest.participants.push({id:t.options.user._id,pDate:Date.now(),name:t.options.user.name,avatar:t.options.user.avatar,likes:{paid:[],free:[]}})},function(t){console.error(t.data)}))}}]),angular.module("MuscleMan").controller("ContestsCtrl",["$scope","User",function(t,e){t.contests=[],t.format_date=function(t){return moment(t).format("DD.MM.YYYY")},e.get_contest("all",function(e){t.contests=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("DialogsCtrl",["$scope","Dialog",function(t,e){t.dialog="",t.message="",t.dialogs=[],t.messages=[],e.get(function(e){t.dialogs=e.data,t.set_messages(t.dialogs[0],0)},function(t){console.error(t.data)}),t.format_date=function(t){return moment(t).format("DD.MM.YYYY")},t.set_messages=function(e,n){t.messages=e.messages,t.dialogIndex=n,t.dialog=e._id,t.message=""},t.check_enter=function(e){13===e.keyCode&&t.add_message()},t.add_message=function(){if(t.message){var n={t:Date.now(),text:t.message,uid:t.options.user._id},o=t.dialogs[t.dialogIndex].users.filter(function(e){return e.id!==t.options.user._id})[0];e.add_message(t.dialog,{message:n,addressee:o},function(e){t.$emit("new_message",{target:o.id,message:n.text,t:new Date,avatar:t.options.user.avatar,fio:t.options.user.name+" "+t.options.user.surname}),t.dialogs[t.dialogIndex].messages.push(n),t.message=""},function(t){console.error(t.data)})}},t.delete_dialog=function(n,o){e["delete"](n._id,function(e){t.messages=[],t.dialogs.splice(o,1)},function(t){console.error(t.data)})},t.detect_user=function(t,e){if(!t)return"";var n=t.users.filter(function(t){return t.id===e})[0];return n?n:""},t.with_user=function(e){return e?e.users.filter(function(e){return e.id!==t.options.user._id})[0]:""}}]),angular.module("MuscleMan").controller("FavsCtrl",["$scope","MSG","User","Dialog",function(t,e,n,o){t.favs=[],n.get_favs(function(e){t.favs=e.data},function(t){console.error(t.data)}),n.get_sports(function(e){t.sports=e.data},function(t){e.err(t.data)}),n.get_hobbies(function(e){t.hobbies=e.data},function(t){e.err(t.data)}),t.send_message=function(e){t.$emit("new_message",e)},t.remove_from_fav=function(e){t.options.user.favs=t.options.user.favs.filter(function(t){return t.id!==e}),t.favs=t.favs.filter(function(t){return t._id!==e}),t.$emit("user_save")},t.add_comment=function(n){var o=t.options.user.favs.length;e.custom({title:"Ваш комментарий",text:"введите ниже",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(e){if(e){for(;o--;)t.options.user.favs[o].id===n&&(t.options.user.favs[o].comment=e);t.$emit("user_save")}})},t.get_user_comment=function(e){if(t.options.user.favs.length)return t.options.user.favs.filter(function(t){return t.id===e})[0].comment},t.write_message=function(n){e.custom({title:"Новое сообщение!",text:"Введите текст сообщения",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(e){if(e){var r={addressee:{id:n._id,avatar:n.avatar,fio:n.name+" "+n.surname},message:{text:e,t:Date.now(),uid:t.options.user._id}},i={message:e,target:n._id,avatar:t.options.user.avatar,fio:t.options.user.name+" "+t.options.user.surname};o.check(n._id,function(e){o.add_message(e.data._id,{addressee:n._id,message:r.message},function(e){t.send_message(i),$location.path("/dialogs")},function(t){console.error(t.data)})},function(e){o.create(r,function(e){t.send_message(i),$location.path("/dialogs")},function(t){console.error(t.data)})})}else swal.showInputError("Введите хоть что-нибудь...")})}}]),angular.module("MuscleMan").controller("ForgotCtrl",["$scope","$location","User","MSG","LS",function(t,e,n,o,r){t.cred={mail:""},t.forgot=function(){t.cred.mail.$error||(t.options.loading=!0,n.forgot(t.cred,function(e){t.options.loading=!1,o.ok(e.data)},function(e){t.options.loading=!1,o.err(e.data)}))}}]),angular.module("MuscleMan").controller("MainCtrl",["$scope","$location","socket","User","LS","MSG","notify",function(t,e,n,o,r,i,a){t.meta={description:"",content:""},t.cred={mail:"",pass:""},t.options={user:r.get("user")||0},t.signin=function(){t.cred.mail.$error||(t.options.loading=!0,o.signin(t.cred,function(o){console.log(o.data),r.set("user",o.data),t.options.loading=!1,t.options.user=o.data,e.path("/user/"+t.options.user._id),n.emit("user:online",{id:t.options.user._id})},function(e){if(t.options.loading=!1,401===e.status)return void i.err("Неверный логин или пароль!")}))},t.getloc=function(){return"#/"===location.hash},t.options.user&&n.emit("user:online",{id:t.options.user._id}),n.on("new:message",function(e){if(console.log("new:message"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вас новое сообщение!",{icon:e.avatar,body:e.fio+" сказал"+e.text});a.play(),setTimeout(n.close.bind(n),3e3)}}),n.on("photo:comment",function(e){if(console.log("photo:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вашего фото новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});a.play(),setTimeout(n.close.bind(n),3e3)}}),n.on("video:comment",function(e){if(console.log("video:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вашего видео новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});a.play(),setTimeout(n.close.bind(n),3e3)}}),t.getloc=function(){return"#/"===location.hash},!!t.options.user&&o.get(function(e){t.options.user=e.data,r.set("user",e.data)},function(t){e.path("/signup")}),t.$on("new_message",function(t,e){n.emit("new:message",e)}),t.$on("user_save",function(){o.set(t.options.user,function(e){r.set("user",t.options.user),console.log("User saved!")},function(t){console.error(t.data)})})}]),angular.module("MuscleMan").controller("ManageArticleCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){t.froalaOptions={language:"ru",imageInsertButtons:"imageByURL",placeholderText:"Введите текст новости",imageAllowedTypes:["jpeg","jpg","png"],toolbarButtons:["bold","italic","underline","strikeThrough","fontSize","|","emoticons","color","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","quote","insertHR","-","insertLink","insertImage"]},n.get_article(o.id,function(e){t.article=e.data},function(t){console.error(t.data)}),n.get_themes(function(e){t.themes=e.data},function(t){console.error(t.data)}),n.get_sports(function(e){t.sports=e.data},function(t){console.error(t.data)}),t.update_article=function(){n.update_article(o.id,t.article,function(t){window.history.back()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManageCompetitionCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){n.get_competition(o.id,function(e){t.competition=e.data,t.competition.start=new Date(t.competition.start),t.competition.end=new Date(t.competition.end)},function(t){console.error(t.data)}),n.get_sports(function(e){t.sports=e.data},function(t){console.error(t)}),t.update_competition=function(){n.update_competition(o.id,t.competition,function(t){window.history.back()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManageContestCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){var r=o.id;n.get_contest(r,function(e){t.contest=e.data,t.contest.dateStart=new Date(t.contest.dateStart),t.contest.dateEnd=new Date(t.contest.dateEnd),t.contest.dateParticipate=new Date(t.contest.dateParticipate)},function(t){console.error(t.data)}),t.del=function(e){t.contest.participants.splice(e,1),t.update_contest()},t.update_contest=function(){n.update_contest(r,t.contest,function(t){alert("Saved!")},function(t){alert("Error! "+t.data)})}}]),angular.module("MuscleMan").controller("ManageUserCtrl",["$scope","User","Manager","$routeParams",function(t,e,n,o){e.load(o.id,function(e){t.user=e.data},function(t){console.error(t.data)}),t.del_wp=function(e){t.user.workplaces.splice(e,1),t.update_user()},t.del_ac=function(e){t.user.achievements.splice(e,1),t.update_user()},t.del_un=function(e){t.user.universities.splice(e,1),t.update_user()},t.update_user=function(){n.update_user(o.id,t.user,function(e){t.user=e.data},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManagerCtrl",["$sce","$scope","$location","Manager","$routeParams",function(t,e,n,o,r){e.items={cred:null,sport:null,hobbie:null,theme:null},e.creDate={users:new Date,photos:new Date,videos:new Date,topics:new Date,articles:new Date,contests:new Date,competitions:new Date},e.article_html=function(e){return t.trustAsHtml(e)},e.add_manager=function(){e.items.cred={login:"",password:""}},e.create_manager=function(){o.create(e.items.cred,function(t){e.items.cred=null,e.managers.push(t.data)},function(t){e.items.cred=null,console.error(t.data)})},e.delete_manager=function(t,n){o["delete"](t,function(t){e.managers.splice(n,1)},function(t){console.error(t.data)})},e.get_themes=function(){o.get_themes(function(t){e.themes=t.data},function(t){console.error(t.data)})},e.add_theme=function(){e.items.theme={title:""}},e.create_theme=function(){o.create_theme(e.items.theme,function(t){e.items.theme=null,e.themes.push(t.data)},function(t){console.error(t.data)})},e.delete_theme=function(t,n){o.delete_theme(t,function(t){e.themes.splice(n,1)},function(t){console.error(t.data)})},e.get_hobbies=function(){o.get_hobbies(function(t){e.hobbies=t.data},function(t){console.error(t.data)})},e.add_hobbie=function(){e.items.hobbie={type:0,item:""}},e.create_hobbie=function(){o.create_hobbie(e.items.hobbie,function(t){e.items.hobbie=null,e.hobbies.push(t.data)},function(t){console.error(t.data)})},e.delete_hobbie=function(t,n){o.delete_hobbie(t,function(t){e.hobbies.splice(n,1)},function(t){console.error(t.data)})},e.get_sports=function(){o.get_sports(function(t){e.sports=t.data},function(t){console.error(t.data)})},e.add_sport=function(){e.items.sport={sex:1,sport:""}},e.create_sport=function(){o.create_sport(e.items.sport,function(t){e.items.sport=null,e.sports.push(t.data)},function(t){console.error(t.data)})},e.delete_sport=function(t,n){o.delete_sport(t,function(t){e.sports.splice(n,1)},function(t){console.error(t.data)})},e.get_managers=function(){o.all(function(t){e.managers=t.data},function(t){console.error(t.data)})},e.set_permission=function(t,n){o.set_permission(t,e.managers[n].permission,function(t){console.log("permission saved")},function(t){console.error(t.data)})},e.get_photos=function(){o.get_photos(e.creDate.photos,function(t){e.photos=t.data},function(t){console.error(t.data)})},e.delete_photo=function(t,n){o.delete_photo(t,function(t){e.photos.splice(n,1);
},function(t){console.error(t.data)})},e.get_videos=function(){o.get_videos(e.creDate.videos,function(t){e.videos=t.data},function(t){console.error(t.data)})},e.delete_video=function(t,n){o.delete_video(t,function(t){e.videos.splice(n,1)},function(t){console.error(t.data)})},e.get_topics=function(){o.get_topics(e.creDate.topics,function(t){e.topics=t.data},function(t){console.error(t.data)})},e.delete_topic=function(t,n){o.delete_topic(t,function(t){e.topics.splice(n,1)},function(t){console.error(t.data)})},e.get_users=function(){o.get_users(e.creDate.users,function(t){e.users=t.data},function(t){console.error(t.data)})},e.delete_user=function(t,n){o.delete_user(t,function(t){e.users.splice(n,1)},function(t){console.error(t.data)})},e.get_articles=function(){o.get_articles(e.creDate.articles,function(t){e.articles=t.data},function(t){console.error(t.data)})},e.create_article=function(){o.create_article(function(t){n.path("/manage/article/"+t.data._id)},function(t){console.error(t.data)})},e.delete_article=function(t,n){o.delete_article(t,function(t){e.articles.splice(n,1)},function(t){console.error(t.data)})},e.create_contest=function(){o.create_contest(function(t){n.path("/manage/contest/"+t.data._id)},function(t){console.error(t.data)})},e.get_contests=function(){o.get_contests(e.creDate.contests,function(t){e.contests=t.data},function(t){console.error(t.data)})},e.delete_contest=function(t,n){o.delete_contest(t,function(t){e.contests.splice(n,1)},function(t){console.error(t.data)})},e.create_competition=function(){o.create_competition(function(t){n.path("/manage/competition/"+t.data._id)},function(t){console.error(t.data)})},e.get_competitions=function(){o.get_competitions(e.creDate.competitions,function(t){e.competitions=t.data},function(t){console.error(t.data)})},e.delete_competition=function(t,n){o.delete_competition(t,function(t){e.competitions.splice(n,1)},function(t){console.error(t.data)})},o.get(r.id,function(t){switch(e.manager=t.data,!0){case e.manager.permission.articles:e.page="article",e.get_articles();break;case e.manager.permission.users:e.page="users",e.get_users();break;case e.manager.permission.photos:e.page="photos",e.get_photos();break;case e.manager.permission.videos:e.page="videos",e.get_videos();break;case e.manager.permission.topics:e.page="topics",e.get_topics();break;case e.manager.permission.contests:e.page="contests",e.get_contests();break;case e.manager.permission.hobbies:e.page="hobbies",e.get_hobbies();break;case e.manager.permission.sports:e.page="sports",e.get_sports();break;case e.manager.permission.managers:e.page="managers",e.get_managers();break;case e.manager.permission.competitions:e.page="competitions",e.get_competitions();break;default:n.path("/manager/signin")}},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ManagerSignInCtrl",["$scope","$location","Manager",function(t,e,n){t.cred={login:"",password:""},t.signin=function(){t.options.loading=!0,n.signin(t.cred,function(n){t.options.loading=!1,t.options.manager=n.data,e.path("/manager/"+t.options.manager._id)},function(e){t.options.loading=!1,console.error(e.data)})}}]),angular.module("MuscleMan").controller("OptionsCtrl",["$scope","$routeParams","MSG","Upload","User","LS","$vk",function(t,e,n,o,r,i,a){t.active_page=e.tab||"profile",t.search={city:null,user:null,chair:null,country:null,faculty:null,speciality:null,university:null},t.cred={password:"",confirmPassword:""},t.currentYear=(new Date).getFullYear(),r.get(function(e){t.options.user=e.data,i.set("user",e.data)},function(t){n.err(t.data)}),t.unlink=function(e){r.unlink(e,function(n){t.options.user.social[e]=void 0,t.options.user.tokens[e]=void 0},function(t){n.err(t.data)})},t.upload_photo=function(e){return console.log(e),t.options.loading=!0,t.fileName=e.name,e?void o.upload({url:"/photo/new",data:{file:e}}).then(function(e){console.log("$scope.options.user:",t.options.user),console.log("res.data.image:",e.data.image),t.options.user.avatar=e.data.image,t.options.loading=!1,t.fileName=null,t.user_save()}):void(t.options.loading=!1)},t.request_permissions=function(){return"Notification"in window?void("denied"!==Notification.permission&&Notification.requestPermission(function(t){if("granted"===t){new Notification("Отлично! Вы разрешили нам уведомлять вас о новых событиях!")}"denied"===t&&n.info("Вы не сможете получать уведомления о новых событиях...")})):void n.err("Ваш браузер не поддерживает уведомления...")},t.load_countries=function(){a.get_countries(function(e){t.countries=e.data},function(t){n.err(t.data)})},t.load_cities=function(){a.get_cities({country_id:t.university?t.university.country_id:t.workplace?t.workplace.country_id:t.achievement?t.achievement.country_id:t.options.user.location_country.id},function(e){t.cities=e.data},function(t){n.err(t.data)})},t.load_universities=function(){a.get_universities({city_id:t.university.city_id,country_id:t.university.country_id},function(e){t.universities=e.data},function(t){n.err(t.data)})},t.load_faculties=function(){a.get_faculties({university_id:t.university.university_id},function(e){t.faculties=e.data},function(t){n.err(t.data)})},t.load_chairs=function(){a.get_chairs({faculty_id:t.university.faculty_id},function(e){t.chairs=e.data},function(t){n.err(t.data)})},t.add_university=function(){t.load_countries(),t.university={city_id:"",country_id:"",university_id:"",faculty_id:"",chair_id:"",city:"",country:"",university:"",faculty:"",chair:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},t.save_university=function(){return t.university.year_end&&t.university.year_start>t.university.year_end?void n.err("Год начала не может быть больше года окончания"):void r.add_university(t.university,function(e){t.options.user.universities.push(t.university),t.university=null},function(t){n.err(t.data)})},t.rm_university=function(e,o){r.rm_university(e,function(e){t.options.user.universities.splice(o,1)},function(t){n.err(t.data)})},t.add_workplace=function(){t.load_countries(),t.workplace={city:"",country:"",city_id:"",country_id:"",company:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},t.save_workplace=function(){return t.workplace.year_end&&t.workplace.year_start>t.workplace.year_end?void n.err("Год начала не может быть больше года окончания"):void r.add_workplace(t.workplace,function(e){t.options.user.workplaces.push(t.workplace),t.workplace=null},function(t){n.err(t.data)})},t.rm_workplace=function(e,o){r.rm_workplace(e,function(e){t.options.user.workplaces.splice(o,1)},function(t){n.err(t.data)})},t.add_achievement=function(){t.load_countries(),t.achievement={city:"",country:"",city_id:"",country_id:"",title:"",place:"",comment:"",year:+(new Date).getFullYear()}},t.save_achievement=function(){r.add_achievement(t.achievement,function(e){t.options.user.achievements.push(t.achievement),t.achievement=null},function(t){n.err(t.data)})},t.rm_achievement=function(e,o){r.rm_achievement(e,function(e){t.options.user.achievements.splice(o,1)},function(t){n.err(t.data)})},t.add_hobbie=function(){r.get_hobbies(function(e){t.hobbies=e.data,t.hobbie={}},function(t){n.err(t.data)})},t.save_hobbie=function(){r.add_hobbie(t.hobbie,function(e){t.options.user.hobbies.push(t.hobbie),t.hobbie=null},function(t){n.err(t.data)})},t.rm_hobbie=function(e,o){r.rm_hobbie(e,function(e){t.options.user.hobbies.splice(o,1)},function(t){n.err(t.data)})},t.add_sport=function(){r.get_sports(function(e){t.sports=e.data,t.sport={}},function(t){n.err(t.data)})},t.save_sport=function(){r.add_sport({sport:t.sport},function(e){t.options.user.sports.push(t.sport),t.sport=null},function(t){n.err(t.data)})},t.rm_sport=function(e,o){r.rm_sport({sport:e},function(e){t.options.user.sports.splice(o,1)},function(t){n.err(t.data)})},t.changepwd=function(){r.changepwd(t.cred,function(t){n.ok("Пароль успешно изменён!")},function(t){n.err(t.data.map(function(t){return t.msg}).join("\n\r"))})},t.user_save=function(){t.$emit("user_save"),n.ok("Сохранено успешно!")}}]),angular.module("MuscleMan").controller("PhotosCtrl",["$scope","$routeParams","socket","Upload","Photo","User","Album","MSG",function(t,e,n,o,r,i,a,c){t.photos=[],t.albums=[],t.gallery={current_photo:null},t.layer={editedAlbum:null,editedPhoto:null},t.manage_photo_keypress=function(e){var n={ESCAPE:27,RIGHT:39,LEFT:37};switch(e.keyCode){case n.ESCAPE:t.gallery.current_photo=null;break;case n.RIGHT:t.turn_photo_right();break;case n.LEFT:t.turn_photo_left()}},t.getDate=function(t){return moment(t).format("DD.MM.YYYY")},t.turn_photo_left=function(){0===t.gallery.current_photo?t.gallery.current_photo=t.photos.length:t.gallery.current_photo--},t.turn_photo_right=function(){t.gallery.current_photo===t.photos.length-1?t.gallery.current_photo=0:t.gallery.current_photo++},i.load(e.id,function(e){t.user=e.data},function(t){console.error(t.data)}),a.get(e.id,function(e){t.albums=e.data},function(t){console.error(t.data)}),r.get(e.id,function(n){t.photos=n.data,"all"!==e.photoid&&t.photos.map(function(n,o){n._id===e.photoid&&(t.gallery.current_photo=o)})},function(t){console.error(t.data)}),t.set_avatar=function(e){t.options.user.avatar=e.image,t.$emit("user_save")},t.create_album=function(){c.custom({type:"input",closeOnConfirm:!1,showCancelButton:!0,cancelButtonText:"Отмена",inputPlaceholder:"Название",text:"Введите название альбома",title:"Название"},function(e){e&&a.create(e,function(e){c.ok("Альбом создан!"),t.albums.push(e.data)},function(t){c.err(t.data),console.error(t.data)})})},t.edit_photo=function(e){r.edit(e,function(e){t.photos=t.photos.map(function(e){return e._id===t.layer.editedPhoto._id&&(e._id=t.layer.editedPhoto._id),e}),t.layer.editedPhoto=null,c.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},t.like_photo=function(){var e=t.photos[t.gallery.current_photo].likes.indexOf(t.options.user._id);e===-1?r.add_like(t.photos[t.gallery.current_photo],function(e){t.photos[t.gallery.current_photo].likes.push(t.options.user._id)},function(t){console.error(t.data)}):r.remove_like(t.photos[t.gallery.current_photo],function(n){t.photos[t.gallery.current_photo].likes.splice(e,1)},function(t){console.error(t.data)})},t.add_photo_comment=function(){if(t.gallery.comment){var o={date:Date.now(),name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname,_id:t.photos[t.gallery.current_photo]._id};r.add_comment(o,function(r){t.gallery.comment="",t.photos[t.gallery.current_photo].comments.push(o),e.id!==t.options.user._id&&(o.target=e.id,n.emit("photo:comment",o))},function(t){console.error(t.data)})}},t.remove_photo_comment=function(e){r.remove_comment({comment:e,_id:t.photos[t.gallery.current_photo]._id},function(n){t.photos[t.gallery.current_photo].comments=t.photos[t.gallery.current_photo].comments.filter(function(n){return!(n.userid===t.options.user._id&&n.comment===e)})},function(t){console.error(t.data)})},t.edit_album=function(e){a.set_title(e,function(e){t.albums=t.albums.map(function(e){return e._id===t.layer.editedAlbum._id&&(e._id=t.layer.editedAlbum._id),e}),t.layer.editedAlbum=null,c.ok("Наименование альбома успешно изменено!")},function(t){console.error(t.data)})},t.delete_album=function(e){a["delete"](e,function(n){t.albums=t.albums.filter(function(t){return t._id!==e})},function(t){console.error(t.data)})},t.delete_photo=function(e){t.options.loading=!0,r["delete"](t.photos[e]._id,function(n){t.photos=t.photos.filter(function(n){return n._id!==t.photos[e]._id}),t.options.loading=!1},function(e){t.options.loading=!1,console.error(e.data)})},t.upload_files=function(e){if(t.options.loading=!0,e&&e.length)for(var n=0;n<e.length;n++)!function(n){o.upload({url:"/photo/new",data:{file:e[n]}}).then(function(o){t.photos.push(o.data),!(n<e.length)&&(t.options.loading=!1)})}(n)}}]),angular.module("MuscleMan").controller("ResetCtrl",["$scope","$routeParams","$location","User","MSG","LS",function(t,e,n,o,r,i){t.cred={pass:"",token:e.token},t.reset=function(){t.options.loading=!0,o.reset(t.cred,function(t){r.ok("Прекрасно! Теперь вы можете войти со своим новым паролем!"),n.path("/signin")},function(e){t.options.loading=!1,r.err(e.data)})}}]),angular.module("MuscleMan").controller("SearchCtrl",["$scope","User",function(t,e){t.search={location_country:t.options.user.location_country},t.users=[],t.me=function(e){return t.options.user._id===e},t.get_age=function(t){var e=moment(),t=moment(t);return e.diff(t,"years")},e.get_sports(function(e){t.sports=e.data},function(t){MSG.err(t.data)}),e.get_hobbies(function(e){t.hobbies=e.data},function(t){MSG.err(t.data)}),t.in_fav=function(e){return!!t.options.user.favs&&t.options.user.favs.filter(function(t){return t.id.indexOf(e)>=0}).length},t.fav=function(e){t.in_fav(e)?t.options.user.favs=t.options.user.favs.filter(function(t){return t.id!==e}):t.options.user.favs.push({id:e,comment:""}),t.$emit("user_save")},t.find_users=function(){t.search.fio&&(t.search.name=t.search.fio.split(" ")[0],t.search.surname=t.search.fio.split(" ")[1]),e.search(t.search,function(e){t.users=e.data},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("SignInCtrl",["$scope","$location","socket","User","MSG","LS",function(t,e,n,o,r,i){t.cred={mail:"",pass:""},t.signin=function(){t.cred.mail.$error||(t.options.loading=!0,o.signin(t.cred,function(o){console.log(o.data),i.set("user",o.data),t.options.loading=!1,t.options.user=o.data,e.path("/user/"+t.options.user._id),n.emit("user:online",{id:t.options.user._id})},function(n){t.options.loading=!1,r.err("Забыли пароль?"),e.path("/forgot")}))}}]),angular.module("MuscleMan").controller("SignUpCtrl",["$scope","$location","socket","User","MSG","LS",function(t,e,n,o,r,i){t.cred={mail:"",pass:""},t.signup=function(){t.cred.mail.$error||(t.options.loading=!0,o.signup(t.cred,function(o){i.set("user",o.data),t.options.loading=!1,t.options.user=o.data,e.path("/options"),n.emit("user:online",{id:t.options.user._id})},function(t){r.err(t.data.map(function(t){return t.msg}).join("\n\r"))}))}}]),angular.module("MuscleMan").controller("UserCtrl",["$sce","$scope","$location","$routeParams","socket","User","MSG","Topic","Photo","Video","Dialog","Upload",function(t,e,n,o,r,i,a,c,s,u,l,d){e.user={},e.photos=[],e.topics=[],e.gallery={current_photo:null,current_video:null,add_image:null};var p={ESCAPE:27,RIGHT:39,LEFT:37};e.manage_photo_keypress=function(t){switch(t.keyCode){case p.ESCAPE:e.gallery.current_photo=null;break;case p.RIGHT:e.turn_photo_right();break;case p.LEFT:e.turn_photo_left()}},e.manage_video_keypress=function(t){switch(t.keyCode){case p.ESCAPE:e.gallery.current_video=null;break;case p.RIGHT:e.turn_video_right();break;case p.LEFT:e.turn_video_left()}},e.last_seen=function(){return moment(e.user.lastOnline).fromNow()},!e.options.user&&n.path("/signin"),i.load(o.id,function(t){e.user=t.data,e.rating=0,e.user.marks&&(e.user.marks.map(function(t){e.rating+=t.mark}),e.rating=Math.round(e.rating/e.user.marks.length*100)/100)},function(t){console.error(t.data)}),s.get(o.id,function(t){e.photos=t.data},function(t){console.error(t.data)}),u.get(o.id,function(t){e.videos=t.data},function(t){console.error(t.data)}),c.get(o.id,function(t){e.topics=t.data},function(t){console.error(t.data)}),e.in_fav=function(){return!!e.options.user.favs&&e.options.user.favs.indexOf(e.user._id)>=0},e.fav=function(){e.in_fav(e.user._id)?e.options.user.favs=e.options.user.favs.filter(function(t){return t!==e.user._id}):e.options.user.favs.push(e.user._id),e.user_save()},e.is_marked=function(){return e.user.marks.filter(function(t){return t.userid===e.options.user._id}).length},e.mark=function(t){if(e.options.user._id!==e.user._id){var n=function(){e.rating=0,e.user.marks.map(function(t){e.rating+=t.mark}),e.rating=Math.round(e.rating/e.user.marks.length*100)/100};e.is_marked()?i.rm_mark({id:o.id},function(t){e.user.marks=e.user.marks.filter(function(t){return t.userid!==e.options.user._id}),n()},function(t){a.err(t.data)}):i.add_mark({id:o.id,mark:t},function(o){e.user.marks.push({userid:e.options.user._id,mark:t}),n()},function(t){a.err(t.data)})}},e.get_age=function(t){var e=moment(),t=moment(t);return e.diff(t,"years")},e.birth_date=function(t){return moment(t).format("DD.MM.YYYY")},e.turn_photo_left=function(){0===e.gallery.current_photo?e.gallery.current_photo=e.photos.length:e.gallery.current_photo--},e.turn_photo_right=function(){e.gallery.current_photo==e.photos.length-1?e.gallery.current_photo=0:e.gallery.current_photo++},e.include_video=function(e,n){switch(e){case"vimeo":return t.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return t.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},e.turn_video_left=function(){0===e.gallery.current_video?e.gallery.current_video=e.videos.length:e.gallery.current_video--},e.turn_video_right=function(){e.gallery.current_video==e.videos.length-1?e.gallery.current_video=0:e.gallery.current_video++},e.user_save=function(){e.$emit("user_save")},e.send_message=function(t){e.$emit("new_message",t)},e.add_image_to_topic=function(t){var n=e.topic.images.indexOf(t);n===-1?e.topic.images.push(t):e.topic.images.splice(n,1)},e.add_video_to_topic=function(t){var n=-1;e.topic.videos.map(function(e,o){e._id===t._id&&(n=o)}),n===-1?e.topic.videos.push(t):e.topic.videos.splice(n,1)},e.add_topic=function(){e.topic={text:"",images:[],videos:[],comment:""}},e.new_topic=function(){c["new"](e.topic,function(t){e.topics.push(t.data),e.topic={text:"",images:[],comment:""}},function(t){console.error(t.data)})},e.del_topic=function(t){c.del(e.topics[t]._id,function(n){e.topics.splice(t,1)},function(t){console.error(t.data)})},e.upload_files=function(t){if(e.options.loading=!0,t&&t.length)for(var n=0;n<t.length;n++)!function(n){d.upload({url:"/photo/new",data:{file:t[n]}}).then(function(o){e.photos.push(o.data),!(n<t.length)&&(e.options.loading=!1)})}(n)},e.add_photo_comment=function(){if(e.gallery.comment){var t={date:Date.now(),name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname,_id:e.photos[e.gallery.current_photo]._id};s.add_comment(t,function(n){e.gallery.comment="",e.photos[e.gallery.current_photo].comments.push(t),o.id!==e.options.user._id&&(t.target=o.id,r.emit("photo:comment",t))},function(t){console.error(t.data)})}},e.remove_photo_comment=function(t){s.remove_comment({comment:t,_id:e.photos[e.gallery.current_photo]._id},function(n){e.photos[e.gallery.current_photo].comments=e.photos[e.gallery.current_photo].comments.filter(function(n){return!(n.userid===e.options.user._id&&n.comment===t)})},function(t){console.error(t.data)})},e.add_video_comment=function(t){if(e.gallery.comment){var n={date:Date.now(),name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname,_id:e.videos[e.gallery.current_video]._id};u.add_comment(n,function(t){e.gallery.comment="",e.videos[e.gallery.current_video].comments.push(n),o.id!==e.options.user._id&&(n.target=o.id,r.emit("photo:comment",n))},function(t){console.error(t.data)})}},e.remove_video_comment=function(t){u.remove_comment({comment:t,_id:e.videos[e.gallery.current_video]._id},function(n){e.videos[e.gallery.current_video].comments=e.videos[e.gallery.current_video].comments.filter(function(n){return!(n.userid===e.options.user._id&&n.comment===t)})},function(t){console.error(t.data)})},e.add_topic_comment=function(t){var n={date:Date.now(),comment:e.topic.comment,_id:e.topics[t]._id,name:e.options.user.name,userid:e.options.user._id,avatar:e.options.user.avatar,surname:e.options.user.surname};c.add_comment(n,function(i){e.topic.comment="",e.topics[t].comments.push(n),o.id!==e.options.user._id&&(n.target=o.id,r.emit("topic:comment",n))},function(t){console.error(t.data)})},e.remove_topic_comment=function(t,n){c.remove_comment({comment:n,_id:e.topics[t]._id},function(o){e.topics[t].comments=e.topics[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===n)})},function(t){console.error(t.data)})},e.like_photo=function(){var t=e.photos[e.gallery.current_photo].likes.indexOf(e.options.user._id);t===-1?s.add_like(e.photos[e.gallery.current_photo],function(t){e.photos[e.gallery.current_photo].likes.push(e.options.user._id)},function(t){console.error(t.data)}):s.remove_like(e.photos[e.gallery.current_photo],function(n){e.photos[e.gallery.current_photo].likes.splice(t,1)},function(t){console.error(t.data)})},e.like_video=function(){var t=e.videos[e.gallery.current_video].likes.indexOf(e.options.user._id);t===-1?u.add_like(e.videos[e.gallery.current_video],function(t){e.videos[e.gallery.current_video].likes.push(e.options.user._id)},function(t){console.error(t.data)}):u.remove_like(e.videos[e.gallery.current_video],function(n){e.videos[e.gallery.current_video].likes.splice(t,1)},function(t){console.error(t.data)})},e.write_message=function(){a.custom({title:"Новое сообщение!",text:"Введите текст сообщения",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(t){if(t){var o={addressee:{id:e.user._id,avatar:e.user.avatar,fio:e.user.name+" "+e.user.surname},message:{text:t,t:Date.now(),uid:e.options.user._id}},r={message:t,target:e.user._id,avatar:e.options.user.avatar,fio:e.options.user.name+" "+e.options.user.surname};l.check(e.user._id,function(t){l.add_message(t.data._id,{addressee:e.user._id,message:o.message},function(t){e.send_message(r),n.path("/dialogs")},function(t){console.error(t.data)})},function(t){l.create(o,function(t){e.send_message(r),n.path("/dialogs")},function(t){console.error(t.data)})})}else swal.showInputError("Введите хоть что-нибудь...")})}}]),angular.module("MuscleMan").controller("VideosCtrl",["$sce","$http","$scope","$routeParams","Video","User","socket","MSG",function(t,e,n,o,r,i,a,c){n.videos=[],n.layer={addVideo:null,editedVideo:null},n.gallery={current_video:null},n.manage_video_keypress=function(t){switch(t.keyCode){case btn.ESCAPE:n.gallery.current_video=null;break;case btn.RIGHT:n.turn_video_right();break;case btn.LEFT:n.turn_video_left()}},n.getDate=function(t){return moment(t).format("DD.MM.YYYY")},i.load(o.id,function(t){n.user=t.data},function(t){console.error(t.data)}),r.get(o.id,function(t){n.videos=t.data,"all"!==o.videoid&&n.videos.map(function(t,e){t._id===o.videoid&&(n.gallery.current=e)})},function(t){console.error(t.data)}),n.include_video=function(e,n){switch(e){case"vimeo":return t.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return t.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},n.turn_video_left=function(){0==n.gallery.current_video?n.gallery.current_video=n.videos.length:n.gallery.current_video--},n.turn_video_right=function(){n.gallery.current_video==n.videos.length-1?n.gallery.current_video=0:n.gallery.current_video++},n.add_video=function(){var t={title:n.layer.addVideo.title},o=n.layer.addVideo.link.trim();switch(!0){case 0===o.indexOf("https://www.youtube.com/watch?v="):t.type="youtube",t.link=o.split("https://www.youtube.com/watch?v=")[1];break;case 0===o.indexOf("https://www.youtu.be/"):t.type="youtube",t.link=o.split("https://www.youtu.be/")[1];break;case 0===o.indexOf("https://vimeo.com/"):t.type="vimeo",t.link=o.split("https://vimeo.com/")[1];break;default:return void c.err("Даннный тип видеохостинга пока не поддерживается!")}"vimeo"===t.type?e.get("https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/"+t.link).then(function(e){t.thumbnail=e.data.thumbnail_url,r.add(t,function(t){n.videos.push(t.data),n.layer.addVideo=null},function(t){console.error(t.data)})},function(t){console.error(t.data)}):(t.thumbnail="//img.youtube.com/vi/"+t.link+"/0.jpg",r.add(t,function(t){n.videos.push(t.data),n.layer.addVideo=null},function(t){console.error(t.data)}))},n.edit_video=function(t){r.edit(t,function(t){n.videos=n.videos.map(function(t){return t._id===n.layer.editedVideo._id&&(t._id=n.layer.editedVideo._id),t}),n.layer.editedvideo=null,c.ok("Настройки видео успешно изменены!")},function(t){console.error(t.data)})},n.delete_video=function(t){r["delete"](n.videos[t]._id,function(e){n.videos.splice(t,1)},function(t){console.error(t.data)})},n.like_video=function(t){var e=n.videos[n.gallery.current_video].likes.indexOf(n.options.user._id);e===-1?r.add_like(n.videos[n.gallery.current_video],function(e){n.videos[t].likes.push(n.options.user._id)},function(t){console.error(t.data)}):r.remove_like(n.videos[n.gallery.current_video],function(t){n.videos[n.gallery.current_video].likes.splice(e,1)},function(t){console.error(t.data)})},n.add_video_comment=function(){var t={date:Date.now(),name:n.options.user.name,userid:n.options.user._id,comment:n.gallery.comment,avatar:n.options.user.avatar,surname:n.options.user.surname,_id:n.videos[n.gallery.current_video]._id};r.add_comment(t,function(e){n.gallery.comment="",n.videos[n.gallery.current_video].comments.push(t),o.id!==n.options.user._id&&(t.target=o.id,a.emit("video:comment",t))},function(t){console.error(t.data)})},n.remove_video_comment=function(t){r.remove_comment({comment:t,_id:n.videos[n.gallery.current_video]._id},function(e){n.videos[n.gallery.current_video].comments=n.videos[n.gallery.current_video].comments.filter(function(e){return!(e.userid===n.options.user._id&&e.comment===t)})},function(t){console.error(t.data)})}}]);