angular.module("MuscleMan",["ngLocale","ngFileUpload","ngRoute","720kb.datepicker","Services"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"tpl/main.tpl",controller:"MainCtrl"}).when("/auth",{templateUrl:"tpl/auth.tpl",controller:"AuthCtrl"}).when("/user/:userid/album/:id",{templateUrl:"tpl/album.tpl",controller:"AlbumCtrl"}).when("/articles",{templateUrl:"tpl/articles.tpl",controller:"ArticlesCtrl"}).when("/article/:id",{templateUrl:"tpl/article.tpl",controller:"ArticleCtrl"}).when("/competitions",{templateUrl:"tpl/competitions.tpl",controller:"CompetitionsCtrl"}).when("/competition/:id",{templateUrl:"tpl/competition.tpl",controller:"CompetitionCtrl"}).when("/contests",{templateUrl:"tpl/contests.tpl",controller:"ContestsCtrl"}).when("/contest/:id",{templateUrl:"tpl/contest.tpl",controller:"ContestCtrl"}).when("/dialogs",{templateUrl:"tpl/dialogs.tpl",controller:"DialogsCtrl"}).when("/favs",{templateUrl:"tpl/favs.tpl",controller:"FavsCtrl"}).when("/user/:id/photos/:photoid",{templateUrl:"tpl/photos.tpl",controller:"PhotosCtrl"}).when("/user/:id/videos/:videoid",{templateUrl:"tpl/videos.tpl",controller:"VideosCtrl"}).when("/options",{templateUrl:"tpl/options.tpl",controller:"OptionsCtrl"}).when("/search",{templateUrl:"tpl/search.tpl",controller:"SearchCtrl"}).when("/status",{templateUrl:"tpl/status.tpl",controller:"StatusCtrl"}).when("/user/:id",{templateUrl:"tpl/user.tpl",controller:"UserCtrl"}).otherwise({redirectTo:"/auth"})}]),angular.module("Services",[]).factory("User",["$http",function(t){return{get:function(e,o){return t.get("/user").then(e,o)},load:function(e,o,n){return t.get("/user/"+e).then(o,n)},set:function(e,o,n){return t.put("/user",e).then(o,n)},auth:function(e,o,n){return t.post("/auth",e).then(o,n)},find_users:function(e,o,n){return t.post("/find_users",e).then(o,n)}}}]).factory("Photo",["$http",function(t){return{get:function(e,o,n){return t.get("/photo/"+e).then(o,n)},edit:function(e,o,n){return t.put("/photo/"+e._id,e).then(o,n)},"delete":function(e,o,n){return t["delete"]("/photo/"+e).then(o,n)},add_like:function(e,o,n){return t.put("/photo/"+e._id+"/add_like").then(o,n)},remove_like:function(e,o,n){return t.put("/photo/"+e._id+"/remove_like").then(o,n)},add_comment:function(e,o,n){return t.put("/photo/"+e._id+"/add_comment",e).then(o,n)},remove_comment:function(e,o,n){return t.put("/photo/"+e._id+"/remove_comment",e).then(o,n)}}}]).factory("Video",["$http",function(t){return{get:function(e,o,n){return t.get("/video/"+e).then(o,n)},add:function(e,o,n){return t.post("/video/new",e).then(o,n)},edit:function(e,o,n){return t.put("/video/"+e._id,e).then(o,n)},"delete":function(e,o,n){return t["delete"]("/video/"+e).then(o,n)},add_like:function(e,o,n){return t.put("/video/"+e._id+"/add_like").then(o,n)},remove_like:function(e,o,n){return t.put("/video/"+e._id+"/remove_like").then(o,n)},add_comment:function(e,o,n){return t.put("/video/"+e._id+"/add_comment",e).then(o,n)},remove_comment:function(e,o,n){return t.put("/video/"+e._id+"/remove_comment",e).then(o,n)}}}]).factory("Album",["$http",function(t){return{get:function(e,o,n){return t.get("/album/"+e).then(o,n)},get_one:function(e,o,n){return t.get("/single_album/"+e).then(o,n)},create:function(e,o,n){return t.post("/album/new",{title:e}).then(o,n)},set_title:function(e,o,n){return t.put("/album/"+e._id,e).then(o,n)},add_photo:function(e,o,n){return t.put("/album/"+e._id+"/add_photo/"+e.photoid,e).then(o,n)},remove_photo:function(e,o,n){return t.put("/album/"+e._id+"/remove_photo/"+e.photoid,e).then(o,n)},"delete":function(e,o,n){return t["delete"]("/album/"+e).then(o,n)}}}]).factory("MSG",function(){return{ok:function(t){swal("OK!",t)},info:function(t){swal("Info!",t,"info")},warn:function(t){swal("Warning!",t,"warning")},err:function(t){swal("Error!",t,"error")},custom:function(t,e){swal(t,e)}}}).factory("LS",function(){return{get:function(t){try{var t=localStorage.getItem(t);return t?JSON.parse(t):null}catch(e){return console.error(e),null}},set:function(t,e){try{var o=e?JSON.stringify(e):"";return localStorage.setItem(t,o),!0}catch(n){return localStorage.clear(),console.error(n),!1}}}}).factory("socket",["$rootScope",function(t){var e=io();return{on:function(o,n){e.on(o,function(){var o=arguments;t.$apply(function(){n.apply(e,o)})})},emit:function(o,n,r){e.emit(o,n,function(){var o=arguments;t.$apply(function(){r&&r.apply(e,o)})})}}}]),angular.module("MuscleMan").controller("AlbumCtrl",["$scope","$routeParams","Photo","Album",function(t,e,o,n){t.album={},t.photos=[],t.gallery={current:null},t.turnLeft=function(){0==t.gallery.current?t.gallery.current=t.photos.length:t.gallery.current--},t.turnRight=function(){t.gallery.current==t.photos.length-1?t.gallery.current=0:t.gallery.current++},o.get(e.userid,function(o){t.photos=o.data.filter(function(t){return t.album===e.id})},function(t){console.error(t.data)}),n.get_one(e.id,function(e){t.album=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ArticleCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("ArticlesCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("AuthCtrl",["$scope","$location","socket","User","LS",function(t,e,o,n,r){t.cred={mail:"",pass:""},t.auth=function(){t.cred.mail.$error||n.auth(t.cred,function(n){switch(t.options.loading=!1,n.status){case 202:r.set("user",n.data),o.emit("user:created"),t.options.user=n.data,e.path("/user/"+t.options.user._id);break;default:o.emit("user:created"),e.path("/options")}},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("CompetitionCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("CompetitionsCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("ContestCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("ContestsCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("DialogsCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("FavsCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("MainCtrl",["$scope","socket","User","LS",function(t,e,o,n){e.on("user:online",function(t){console.log("user:online"),console.log(t)}),e.on("message:send",function(t){console.log("message:send"),console.log(t)}),e.on("photo:comment",function(e){if(console.log("photo:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications&&t.options.user.settings.notify_photo_comments){var o=new Notification("У вашего фото новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});setTimeout(o.close.bind(o),3e3)}}),e.on("video:comment",function(e){if(console.log("video:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications&&t.options.user.settings.notify_video_comments){var o=new Notification("У вашего видео новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});setTimeout(o.close.bind(o),3e3)}}),t.message_send=function(t){e.emit("message:send",t)},t.options={user:n.get("user")||0},t.getloc=function(){return"#/"===location.hash},!!t.options.user&&o.get(function(e){t.options.user=e.data,n.set("user",e.data)},function(t){location.hash="#/auth"}),t.$on("user_save",function(){o.set(t.options.user,function(e){n.set("user",t.options.user),console.log("User saved!")},function(t){console.error(t.data)})})}]),angular.module("MuscleMan").controller("OptionsCtrl",["$scope","MSG",function(t,e){t.cred={old_password:"",new_password:""},t.active_page="profile",t.request_permissions=function(){return"Notification"in window?void("denied"!==Notification.permission&&Notification.requestPermission(function(t){if("granted"===t){new Notification("Отлично! Вы разрешили нам уведомлять вас о новых событиях!")}"denied"===t&&e.info("Вы не сможете получать уведомления о новых событиях...")})):void e.err("Ваш браузер не поддерживает уведомления...")},t.user_save=function(){t.$emit("user_save")}}]),angular.module("MuscleMan").controller("PhotosCtrl",["$scope","$routeParams","socket","Upload","Photo","Album","MSG",function(t,e,o,n,r,i,l){t.photos=[],t.options.userid=e.id,t.albums=[],t.layer={editedAlbum:null,editedPhoto:null},t.gallery={current:null},t.turn_left=function(){0==t.gallery.current?t.gallery.current=t.photos.length:t.gallery.current--},t.turn_right=function(){t.gallery.current==t.photos.length-1?t.gallery.current=0:t.gallery.current++},i.get(e.id,function(e){t.albums=e.data},function(t){console.error(t.data)}),r.get(e.id,function(o){t.photos=o.data,"all"!==e.photoid&&t.photos.map(function(o,n){o._id===e.photoid&&(t.gallery.current=n)})},function(t){console.error(t.data)}),t.set_avatar=function(e){t.options.user.avatar=e.image,t.$emit("user_save")},t.create_album=function(){l.custom({type:"input",closeOnConfirm:!1,showCancelButton:!0,cancelButtonText:"Отмена",inputPlaceholder:"Название",text:"Введите название альбома",title:"Название"},function(e){e&&i.create(e,function(e){l.ok("Альбом создан!"),t.albums.push(e.data)},function(t){l.err(t.data),console.error(t.data)})})},t.edit_photo=function(e){r.edit(e,function(e){t.photos=t.photos.map(function(e){return e._id===t.layer.editedPhoto._id&&(e._id=t.layer.editedPhoto._id),e}),t.layer.editedPhoto=null,l.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},t.like=function(e,o){var n=e.likes.indexOf(t.options.user._id);n===-1?r.add_like(e,function(e){t.photos[o].likes.push(t.options.user._id)},function(t){console.error(t.data)}):r.remove_like(e,function(e){t.photos[o].likes.splice(n,1)},function(t){console.error(t.data)})},t.add_comment=function(n){var i={date:Date.now(),name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname,_id:t.photos[t.gallery.current]._id};r.add_comment(i,function(r){t.gallery.comment="",t.photos[n].comments.push(i),e.id!==t.options.user._id&&(i.target=e.id,o.emit("photo:comment",i))},function(t){console.error(t.data)})},t.remove_comment=function(e,o){r.remove_comment({comment:o,_id:t.photos[t.gallery.current]._id},function(n){t.photos[e].comments=t.photos[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===o)})},function(t){console.error(t.data)})},t.edit_album=function(e){i.set_title(e,function(e){t.albums=t.albums.map(function(e){return e._id===t.layer.editedAlbum._id&&(e._id=t.layer.editedAlbum._id),e}),t.layer.editedAlbum=null,l.ok("Нименование альбома успешно изменено!")},function(t){console.error(t.data)})},t.delete_album=function(e){i["delete"](e,function(o){t.albums=t.albums.filter(function(t){return t._id!==e})},function(t){console.error(t.data)})},t.delete_photo=function(e){r["delete"](e,function(o){t.photos=t.photos.filter(function(t){return t._id!==e})},function(t){console.error(t.data)})},t.upload_files=function(e){if(e&&e.length)for(var o=0;o<e.length;o++)n.upload({url:"/photo/new",data:{file:e[o]}}).then(function(e){t.photos.push(e.data)})}}]),angular.module("MuscleMan").controller("SearchCtrl",["$scope","User",function(t,e){t.search={},t.users=[],t.find_users=function(){t.search.name=t.search.fio.split(" ")[0],t.search.surname=t.search.fio.split(" ")[1],e.find_users(t.search,function(e){t.users=e.data},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("StatusCtrl",["$scope",function(t){t.options={}}]),angular.module("MuscleMan").controller("UserCtrl",["$scope","$routeParams","User","Photo",function(t,e,o,n){t.user={},t.photos=[],o.load(e.id,function(e){t.user=e.data},function(t){console.error(t.data)}),!t.options.user&&$location.path("/auth"),t.getAge=function(t){var e=moment(),t=moment(t);return e.diff(t,"years")},t.birthDate=function(t){return moment(t).format("DD-MM-YYYY")},t.gallery={current:null},t.turnLeft=function(){0==t.gallery.current?t.gallery.current=t.photos.length:t.gallery.current--},t.turnRight=function(){t.gallery.current==t.photos.length-1?t.gallery.current=0:t.gallery.current++},n.get(e.id,function(e){t.photos=e.data},function(t){console.error(t.data)}),t.user_save=function(){t.$emit("user_save")}}]),angular.module("MuscleMan").controller("VideosCtrl",["$sce","$scope","$routeParams","Video","socket","MSG",function(t,e,o,n,r,i){e.videos=[],e.layer={addVideo:null,editedVideo:null},e.gallery={current:null},e.options.userid=o.id,n.get(o.id,function(t){e.videos=t.data,"all"!==o.videoid&&e.videos.map(function(t,n){t._id===o.videoid&&(e.gallery.current=n)})},function(t){console.error(t.data)}),e.include_video=function(e,o){switch(e){case"vimeo":return t.trustAsResourceUrl("https://player.vimeo.com/video/"+o+"?title=0&byline=0&portrait=0");case"youtube":return t.trustAsResourceUrl("https://www.youtube.com/embed/"+o+"?wmode=transparent")}},e.turn_left=function(){0==e.gallery.current?e.gallery.current=$scopvide.length:e.gallery.current--},e.turn_right=function(){e.gallery.current==e.videos.length-1?e.gallery.current=0:e.gallery.current++},e.add_video=function(){var t={title:e.layer.addVideo.title},o=e.layer.addVideo.link.trim();switch(!0){case 0===o.indexOf("https://www.youtube.com/watch?v="):t.type="youtube",t.link=o.split("https://www.youtube.com/watch?v=")[1];break;case 0===o.indexOf("https://www.youtu.be/"):t.type="youtube",t.link=o.split("https://www.youtu.be/")[1];break;case 0===o.indexOf("https://vimeo.com/"):t.type="vimeo",t.link=o.split("https://vimeo.com/")[1];break;default:return void i.err("Даннный тип видеохостинга пока не поддерживается!")}n.add(t,function(t){e.videos.push(t.data),e.layer.addVideo=null},function(t){console.error(t.data)})},e.edit_video=function(t){n.edit(t,function(t){e.videos=e.videos.map(function(t){return t._id===e.layer.editedVideo._id&&(t._id=e.layer.editedVideo._id),t}),e.layer.editedvideo=null,i.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},e.like=function(t,o){var r=t.likes.indexOf(e.options.user._id);r===-1?n.add_like(t,function(t){e.videos[o].likes.push(e.options.user._id)},function(t){console.error(t.data)}):n.remove_like(t,function(t){e.videos[o].likes.splice(r,1)},function(t){console.error(t.data)})},e.add_comment=function(t){var i={date:Date.now(),name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname,_id:e.videos[e.gallery.current]._id};n.add_comment(i,function(n){e.gallery.comment="",e.videos[t].comments.push(i),o.id!==e.options.user._id&&(i.target=o.id,r.emit("video:comment",i))},function(t){console.error(t.data)})},e.remove_comment=function(t,o){n.remove_comment({comment:o,_id:e.videos[e.gallery.current]._id},function(n){e.videos[t].comments=e.videos[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===o)})},function(t){console.error(t.data)})}}]);