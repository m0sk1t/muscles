angular.module("MuscleMan",["ngLocale","ngFileUpload","ngRoute","720kb.datepicker","froala","Services"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"tpl/main.tpl",controller:"MainCtrl"}).when("/manager/signin",{templateUrl:"tpl/manager_signin.tpl",controller:"ManagerSignInCtrl"}).when("/manage/user/:id",{templateUrl:"tpl/manage_user.tpl",controller:"ManageUserCtrl"}).when("/manage/article/:id",{templateUrl:"tpl/manage_article.tpl",controller:"ManageArticleCtrl"}).when("/manage/contest/:id",{templateUrl:"tpl/manage_contest.tpl",controller:"ManageContestCtrl"}).when("/manage/competition/:id",{templateUrl:"tpl/manage_competition.tpl",controller:"ManageCompetitionCtrl"}).when("/manager/:id",{templateUrl:"tpl/manager.tpl",controller:"ManagerCtrl"}).when("/signup",{templateUrl:"tpl/signup.tpl",controller:"SignUpCtrl"}).when("/signin",{templateUrl:"tpl/signin.tpl",controller:"SignInCtrl"}).when("/user/:userid/album/:id",{templateUrl:"tpl/album.tpl",controller:"AlbumCtrl"}).when("/hobbies",{templateUrl:"tpl/hobbies.tpl",controller:"HobbiesCtrl"}).when("/articles",{templateUrl:"tpl/articles.tpl",controller:"ArticlesCtrl"}).when("/article/:id",{templateUrl:"tpl/article.tpl",controller:"ArticleCtrl"}).when("/competitions",{templateUrl:"tpl/competitions.tpl",controller:"CompetitionsCtrl"}).when("/competition/:id",{templateUrl:"tpl/competition.tpl",controller:"CompetitionCtrl"}).when("/contests",{templateUrl:"tpl/contests.tpl",controller:"ContestsCtrl"}).when("/contest/:id",{templateUrl:"tpl/contest.tpl",controller:"ContestCtrl"}).when("/dialogs",{templateUrl:"tpl/dialogs.tpl",controller:"DialogsCtrl"}).when("/favs",{templateUrl:"tpl/favs.tpl",controller:"FavsCtrl"}).when("/user/:id/photos/:photoid",{templateUrl:"tpl/photos.tpl",controller:"PhotosCtrl"}).when("/user/:id/videos/:videoid",{templateUrl:"tpl/videos.tpl",controller:"VideosCtrl"}).when("/options",{templateUrl:"tpl/options.tpl",controller:"OptionsCtrl"}).when("/search",{templateUrl:"tpl/search.tpl",controller:"SearchCtrl"}).when("/user/:id",{templateUrl:"tpl/user.tpl",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(t){console.log("App loaded!")}]),angular.module("Services",[]).factory("User",["$http",function(t){return{get:function(e,n){return t.get("/user").then(e,n)},get_favs:function(e,n){return t.get("/favs").then(e,n)},get_hobbies:function(e,n){return t.get("/hobbies").then(e,n)},get_sports:function(e,n){return t.get("/sports").then(e,n)},get_contest:function(e,n,o){return t.get("/contest/"+e).then(n,o)},get_contest_participants:function(e,n,o){return t.get("/contest_participants/"+e).then(n,o)},add_contest_participant:function(e,n,o){return t.put("/contest/"+e+"/add_participant").then(n,o)},rm_contest_participant:function(e,n,o){return t.put("/contest/"+e+"/rm_participant").then(n,o)},get_competition:function(e,n,o){return t.get("/competition/"+e).then(n,o)},add_mark:function(e,n,o){return t.put("/user/add_mark/"+e.id,e).then(n,o)},rm_mark:function(e,n,o){return t.put("/user/rm_mark/"+e.id,e).then(n,o)},add_university:function(e,n,o){return t.put("/user/add_university",e).then(n,o)},rm_university:function(e,n,o){return t.put("/user/rm_university",e).then(n,o)},add_workplace:function(e,n,o){return t.put("/user/add_workplace",e).then(n,o)},rm_workplace:function(e,n,o){return t.put("/user/rm_workplace",e).then(n,o)},add_achievement:function(e,n,o){return t.put("/user/add_achievement",e).then(n,o)},rm_achievement:function(e,n,o){return t.put("/user/rm_achievement",e).then(n,o)},add_hobbie:function(e,n,o){return t.put("/user/add_hobbie",e).then(n,o)},rm_hobbie:function(e,n,o){return t.put("/user/rm_hobbie",e).then(n,o)},add_sport:function(e,n,o){return t.put("/user/add_sport",e).then(n,o)},rm_sport:function(e,n,o){return t.put("/user/rm_sport",e).then(n,o)},load:function(e,n,o){return t.get("/user/"+e).then(n,o)},set:function(e,n,o){return t.put("/user",e).then(n,o)},signup:function(e,n,o){return t.post("/signup",e).then(n,o)},signin:function(e,n,o){return t.post("/auth/local",e).then(n,o)},changepwd:function(e,n,o){return t.put("/changepwd",e).then(n,o)},unlink:function(e,n,o){return t.put("/unlink/"+e).then(n,o)},search:function(e,n,o){return t.post("/user/search",e).then(n,o)}}}]).factory("Manager",["$http",function(t){return{all:function(e,n){return t.get("/manager/all").then(e,n)},get:function(e,n,o){return t.get("/manager/"+e).then(n,o)},signin:function(e,n,o){return t.post("/manager/signin",e).then(n,o)},create:function(e,n,o){return t.post("/manager/new",e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/manager/"+e).then(n,o)},set_permission:function(e,n,o,r){return t.put("/manager/"+e,n).then(o,r)},create_article:function(e,n){return t.post("/manage/article/new",{}).then(e,n)},create_contest:function(e,n){return t.post("/manage/contest/new",{}).then(e,n)},create_competition:function(e,n){return t.post("/manage/competition/new",{}).then(e,n)},create_hobbie:function(e,n,o){return t.post("/manage/hobbie/new",e).then(n,o)},create_sport:function(e,n,o){return t.post("/manage/sport/new",e).then(n,o)},update_article:function(e,n,o,r){return t.put("/manage/article/"+e,n).then(o,r)},update_contest:function(e,n,o,r){return t.put("/manage/contest/"+e,n).then(o,r)},update_competition:function(e,n,o,r){return t.put("/manage/competition/"+e,n).then(o,r)},update_hobbie:function(e,n,o,r){return t.put("/manage/hobbie/"+e,n).then(o,r)},update_sport:function(e,n,o,r){return t.put("/manage/sport/"+e,n).then(o,r)},update_user:function(e,n,o,r){return t.put("/manage/user/"+e,n).then(o,r)},get_article:function(e,n,o){return t.get("/manage/article/"+e).then(n,o)},get_contest:function(e,n,o){return t.get("/manage/contest/"+e).then(n,o)},get_competition:function(e,n,o){return t.get("/manage/competition/"+e).then(n,o)},get_articles:function(e,n,o){return t.get("/manage/articles/"+e).then(n,o)},get_contests:function(e,n,o){return t.get("/manage/contests/"+e).then(n,o)},get_competitions:function(e,n,o){return t.get("/manage/competitions/"+e).then(n,o)},get_hobbies:function(e,n){return t.get("/hobbies").then(e,n)},get_sports:function(e,n){return t.get("/sports").then(e,n)},get_photos:function(e,n,o){return t.get("/manage/photos/"+e).then(n,o)},get_users:function(e,n,o){return t.get("/manage/users/"+e).then(n,o)},get_videos:function(e,n,o){return t.get("/manage/videos/"+e).then(n,o)},get_topics:function(e,n,o){return t.get("/manage/topics/"+e).then(n,o)},delete_article:function(e,n,o){return t["delete"]("/manage/article/"+e).then(n,o)},delete_competition:function(e,n,o){return t["delete"]("/manage/competition/"+e).then(n,o)},delete_contest:function(e,n,o){return t["delete"]("/manage/contest/"+e).then(n,o)},delete_hobbie:function(e,n,o){return t["delete"]("/manage/hobbie/"+e).then(n,o)},delete_sport:function(e,n,o){return t["delete"]("/manage/sport/"+e).then(n,o)},delete_photo:function(e,n,o){return t["delete"]("/manage/photo/"+e).then(n,o)},delete_video:function(e,n,o){return t["delete"]("/manage/video/"+e).then(n,o)},delete_user:function(e,n,o){return t["delete"]("/manage/user/"+e).then(n,o)},delete_topic:function(e,n,o){return t["delete"]("/manage/topic/"+e).then(n,o)}}}]).factory("Dialog",["$http",function(t){return{get:function(e,n){return t.get("/dialog/all").then(e,n)},check:function(e,n,o){return t.get("/checkdlg/"+e).then(n,o)},create:function(e,n,o){return t.post("/dialog",e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/dialog/"+e).then(n,o)},add_message:function(e,n,o,r){return t.put("/dialog/"+e,n).then(o,r)}}}]).factory("$vk",["$http","$q",function(t,e){return{status:function(){var t=e.defer();return VK.Auth.getLoginStatus(function(e){e?t.resolve(e):t.reject("response error")}),t.promise},login:function(){var t=e.defer();return VK.Auth.login(function(e){e?t.resolve(e):t.reject("response error")}),t.promise},call:function(t,n){var o=e.defer();return VK.Api.call(t,n,function(t){t?o.resolve(t):o.reject("response error")}),o.promise},get_countries:function(e,n){return t.post("vk/database.getCountries",{}).then(e,n)},get_cities:function(e,n,o){return e.count=333,t.post("vk/database.getCities",e).then(n,o)},get_universities:function(e,n,o){return t.post("vk/database.getUniversities",e).then(n,o)},get_faculties:function(e,n,o){return t.post("vk/database.getFaculties",e).then(n,o)},get_chairs:function(e,n,o){return t.post("vk/database.getChairs",e).then(n,o)}}}]).factory("Topic",["$http",function(t){return{get:function(e,n,o){return t.get("/topic/"+e).then(n,o)},"new":function(e,n,o){return t.post("/topic/new",e).then(n,o)},del:function(e,n,o){return t["delete"]("/topic/"+e).then(n,o)},edit:function(e,n,o){return t.put("/topic/"+e._id,e).then(n,o)},add_like:function(e,n,o){return t.put("/topic/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/topic/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/topic/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/topic/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Photo",["$http",function(t){return{get:function(e,n,o){return t.get("/photo/"+e).then(n,o)},edit:function(e,n,o){return t.put("/photo/"+e._id,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/photo/"+e).then(n,o)},add_like:function(e,n,o){return t.put("/photo/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/photo/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/photo/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/photo/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Video",["$http",function(t){return{get:function(e,n,o){return t.get("/video/"+e).then(n,o)},add:function(e,n,o){return t.post("/video/new",e).then(n,o)},edit:function(e,n,o){return t.put("/video/"+e._id,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/video/"+e).then(n,o)},add_like:function(e,n,o){return t.put("/video/"+e._id+"/add_like").then(n,o)},remove_like:function(e,n,o){return t.put("/video/"+e._id+"/remove_like").then(n,o)},add_comment:function(e,n,o){return t.put("/video/"+e._id+"/add_comment",e).then(n,o)},remove_comment:function(e,n,o){return t.put("/video/"+e._id+"/remove_comment",e).then(n,o)}}}]).factory("Album",["$http",function(t){return{get:function(e,n,o){return t.get("/album/"+e).then(n,o)},get_one:function(e,n,o){return t.get("/single_album/"+e).then(n,o)},create:function(e,n,o){return t.post("/album/new",{title:e}).then(n,o)},set_title:function(e,n,o){return t.put("/album/"+e._id,e).then(n,o)},add_photo:function(e,n,o){return t.put("/album/"+e._id+"/add_photo/"+e.photoid,e).then(n,o)},remove_photo:function(e,n,o){return t.put("/album/"+e._id+"/remove_photo/"+e.photoid,e).then(n,o)},"delete":function(e,n,o){return t["delete"]("/album/"+e).then(n,o)}}}]).factory("MSG",function(){return{ok:function(t){swal("OK!",t)},info:function(t){swal("Info!",t,"info")},warn:function(t){swal("Warning!",t,"warning")},err:function(t){swal("Error!",t,"error")},custom:function(t,e){swal(t,e)}}}).factory("LS",function(){return{get:function(t){try{var t=localStorage.getItem(t);return t?JSON.parse(t):null}catch(e){return console.error(e),null}},set:function(t,e){try{var n=e?JSON.stringify(e):"";return localStorage.setItem(t,n),!0}catch(o){return localStorage.clear(),console.error(o),!1}}}}).factory("notify",function(){var t=new Audio("alarm.mp3");return{play:function(){t.play()}}}).factory("socket",["$rootScope",function(t){var e=io();return{on:function(n,o){e.on(n,function(){var n=arguments;t.$apply(function(){o.apply(e,n)})})},emit:function(n,o,r){e.emit(n,o,function(){var n=arguments;t.$apply(function(){r&&r.apply(e,n)})})}}}]),angular.module("MuscleMan").controller("AlbumCtrl",["$scope","$routeParams","Photo","Album",function(t,e,n,o){t.album={},t.photos=[],t.gallery={current:null},t.turnLeft=function(){0==t.gallery.current?t.gallery.current=t.photos.length:t.gallery.current--},t.turnRight=function(){t.gallery.current==t.photos.length-1?t.gallery.current=0:t.gallery.current++},n.get(e.userid,function(n){t.photos=n.data.filter(function(t){return t.album===e.id})},function(t){console.error(t.data)}),o.get_one(e.id,function(e){t.album=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ArticleCtrl",["$scope",function(t){t.article={}}]),angular.module("MuscleMan").controller("ArticlesCtrl",["$scope",function(t){t.articles=[]}]),angular.module("MuscleMan").controller("CompetitionCtrl",["$scope","$routeParams","User",function(t,e,n){t.competition={},n.get_competition(e.id,function(e){t.competition=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("CompetitionsCtrl",["$scope","User",function(t,e){t.competitions=[],e.get_competition("all",function(e){t.competitions=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ContestCtrl",["$scope","$routeParams","User",function(t,e,n){t.contest={},n.get_contest(e.id,function(e){t.contest=e.data,t.get_contest_participants()},function(t){console.error(t.data)}),t.get_contest_participants=function(){n.get_contest_participants(e.id,function(e){t.participants=e.data},function(t){console.error(t.data)})},t.participate=function(){var o=t.contest.participants.indexOf(t.options.user._id);o===-1?n.add_contest_participant(e.id,function(e){t.contest.participants.push(t.options.user._id),t.get_contest_participants()},function(t){console.error(t.data)}):n.rm_contest_participant(e.id,function(e){t.contest.participants.splice(o,1),t.get_contest_participants()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ContestsCtrl",["$scope","User",function(t,e){t.contests=[],e.get_contest("all",function(e){t.contests=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("DialogsCtrl",["$scope","Dialog",function(t,e){t.dialog="",t.message="",t.dialogs=[],t.messages=[],e.get(function(e){t.dialogs=e.data},function(t){console.error(t.data)}),t.set_messages=function(e,n){t.messages=e.messages,t.dialogIndex=n,t.dialog=e._id,t.message=""},t.add_message=function(){var n={t:Date.now(),text:t.message,uid:t.options.user._id},o=t.dialogs[t.dialogIndex].users.filter(function(e){return e.id!==t.options.user._id})[0];e.add_message(t.dialog,{message:n,addressee:o},function(e){t.$emit("new_message",{target:o.id,message:n.text,avatar:t.options.user.avatar,fio:t.options.user.name+" "+t.options.user.surname}),t.dialogs[t.dialogIndex].messages.push(n),t.message=""},function(t){console.error(t.data)})},t.delete_dialog=function(n,o){e["delete"](n._id,function(e){t.messages=[],t.dialogs.splice(o,1)},function(t){console.error(t.data)})},t.with_user=function(e){var n=e.users.filter(function(e){return e.id!==t.options.user._id})[0];return n?n.fio:"пользователь покинул беседу..."}}]),angular.module("MuscleMan").controller("FavsCtrl",["$scope","User",function(t,e){t.favs=[],e.get_favs(function(e){t.favs=e.data},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("HobbiesCtrl",["$scope",function(t){}]),angular.module("MuscleMan").controller("MainCtrl",["$scope","socket","User","LS","notify",function(t,e,n,o,r){t.options={user:o.get("user")||0},t.getloc=function(){return"#/"===location.hash},t.options.user&&e.emit("user:online",{id:t.options.user._id}),e.on("new:message",function(e){if(console.log("new:message"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вас новое сообщение!",{icon:e.avatar,body:e.fio+" сказал"+e.text});r.play(),setTimeout(n.close.bind(n),3e3)}}),e.on("photo:comment",function(e){if(console.log("photo:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вашего фото новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});r.play(),setTimeout(n.close.bind(n),3e3)}}),e.on("video:comment",function(e){if(console.log("video:comment"),console.log(e),"denied"!==Notification.permission&&t.options.user.settings.show_notifications){var n=new Notification("У вашего видео новый комментарий!",{icon:e.avatar,body:e.name+" "+e.surname+" сказал"+e.comment});r.play(),setTimeout(n.close.bind(n),3e3)}}),t.getloc=function(){return"#/"===location.hash},!!t.options.user&&n.get(function(e){t.options.user=e.data,o.set("user",e.data)},function(t){location.hash="#/auth"}),t.$on("new_message",function(t,n){e.emit("new:message",n)}),t.$on("user_save",function(){n.set(t.options.user,function(e){o.set("user",t.options.user),console.log("User saved!")},function(t){console.error(t.data)})})}]),angular.module("MuscleMan").controller("ManageArticleCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){t.froalaOptions={language:"ru",imageInsertButtons:"imageByURL",placeholderText:"Введите текст новости",imageAllowedTypes:["jpeg","jpg","png"],toolbarButtons:["bold","italic","underline","strikeThrough","fontSize","|","emoticons","color","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","quote","insertHR","-","insertLink","insertImage"]},n.get_article(o.id,function(e){t.article=e.data},function(t){console.error(t.data)}),t.update_article=function(){n.update_article(o.id,t.article,function(t){window.history.back()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManageCompetitionCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){n.get_competition(o.id,function(e){t.competition=e.data},function(t){console.error(t.data)}),t.update_competition=function(){n.update_competition(o.id,t.competition,function(t){window.history.back()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManageContestCtrl",["$scope","$location","Manager","$routeParams",function(t,e,n,o){n.get_contest(o.id,function(e){t.contest=e.data},function(t){console.error(t.data)}),t.del=function(e){t.contest.participants.splice(e,1),t.update_contest()},t.update_contest=function(){n.update_contest(o.id,t.contest,function(t){window.history.back()},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManageUserCtrl",["$scope","User","Manager","$routeParams",function(t,e,n,o){e.load(o.id,function(e){t.user=e.data},function(t){console.error(t.data)}),t.del_wp=function(e){t.user.workplaces.splice(e,1),t.update_user()},t.del_ac=function(e){t.user.achievements.splice(e,1),t.update_user()},t.del_un=function(e){t.user.universities.splice(e,1),t.update_user()},t.update_user=function(){n.update_user(o.id,t.user,function(e){t.user=e.data},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("ManagerCtrl",["$sce","$scope","$location","Manager","$routeParams",function(t,e,n,o,r){e.items={cred:null,sport:null,hobbie:null},e.creDate={users:new Date,photos:new Date,videos:new Date,topics:new Date,articles:new Date,contests:new Date,competitions:new Date},e.article_html=function(e){return t.trustAsHtml(e)},e.add_manager=function(){e.items.cred={login:"",password:""}},e.create_manager=function(){o.create(e.items.cred,function(t){e.items.cred=null,e.managers.push(t.data)},function(t){console.error(t.data)})},e.delete_manager=function(t,n){o["delete"](t,function(t){e.managers.splice(n,1)},function(t){console.error(t.data)})},e.get_hobbies=function(){o.get_hobbies(function(t){e.hobbies=t.data},function(t){console.error(t.data)})},e.add_hobbie=function(){e.items.hobbie={type:0,item:""}},e.create_hobbie=function(){o.create_hobbie(e.items.hobbie,function(t){e.items.hobbie=null,e.hobbies.push(t.data)},function(t){console.error(t.data)})},e.delete_hobbie=function(t,n){o.delete_hobbie(t,function(t){e.hobbies.splice(n,1)},function(t){console.error(t.data)})},e.get_sports=function(){o.get_sports(function(t){e.sports=t.data},function(t){console.error(t.data)})},e.add_sport=function(){e.items.sport={sex:1,sport:""}},e.create_sport=function(){o.create_sport(e.items.sport,function(t){e.items.sport=null,e.sports.push(t.data)},function(t){console.error(t.data)})},e.delete_sport=function(t,n){o.delete_sport(t,function(t){e.sports.splice(n,1)},function(t){console.error(t.data)})},e.get_managers=function(){o.all(function(t){e.managers=t.data},function(t){console.error(t.data)})},e.set_permission=function(t,n){o.set_permission(t,e.managers[n].permission,function(t){console.log("permission saved")},function(t){console.error(t.data)})},e.get_photos=function(){o.get_photos(e.creDate.photos,function(t){e.photos=t.data},function(t){console.error(t.data)})},e.delete_photo=function(t,n){o.delete_photo(t,function(t){e.photos.splice(n,1)},function(t){console.error(t.data)})},e.get_videos=function(){o.get_videos(e.creDate.videos,function(t){e.videos=t.data},function(t){console.error(t.data)})},e.delete_video=function(t,n){o.delete_video(t,function(t){e.videos.splice(n,1)},function(t){console.error(t.data)})},e.get_topics=function(){o.get_topics(e.creDate.topics,function(t){e.topics=t.data},function(t){console.error(t.data)})},e.delete_topic=function(t,n){o.delete_topic(t,function(t){e.topics.splice(n,1)},function(t){console.error(t.data)})},e.get_users=function(){o.get_users(e.creDate.users,function(t){e.users=t.data},function(t){console.error(t.data)})},e.delete_user=function(t,n){o.delete_user(t,function(t){e.users.splice(n,1)},function(t){console.error(t.data)})},e.get_articles=function(){o.get_articles(e.creDate.articles,function(t){e.articles=t.data},function(t){console.error(t.data)})},e.create_article=function(){o.create_article(function(t){n.path("/manage/article/"+t.data._id)},function(t){console.error(t.data)})},e.delete_article=function(t,n){o.delete_article(t,function(t){e.articles.splice(n,1)},function(t){console.error(t.data)})},e.create_contest=function(){o.create_contest(function(t){n.path("/manage/contest/"+t.data._id)},function(t){console.error(t.data)})},e.get_contests=function(){o.get_contests(e.creDate.contests,function(t){e.contests=t.data},function(t){console.error(t.data)})},e.delete_contest=function(t,n){o.delete_contest(t,function(t){e.contests.splice(n,1)},function(t){console.error(t.data)})},e.create_competition=function(){o.create_competition(function(t){n.path("/manage/competition/"+t.data._id)},function(t){console.error(t.data)})},e.get_competitions=function(){o.get_competitions(e.creDate.competitions,function(t){e.competitions=t.data},function(t){console.error(t.data)})},e.delete_competition=function(t,n){o.delete_competition(t,function(t){e.competitions.splice(n,1)},function(t){console.error(t.data)})},o.get(r.id,function(t){switch(e.manager=t.data,!0){case e.manager.permission.articles:e.page="article",e.get_articles();break;case e.manager.permission.users:e.page="users",e.get_users();break;case e.manager.permission.photos:e.page="photos",e.get_photos();break;case e.manager.permission.videos:e.page="videos",e.get_videos();break;case e.manager.permission.topics:e.page="topics",e.get_topics();break;case e.manager.permission.contests:e.page="contests",e.get_contests();break;case e.manager.permission.hobbies:e.page="hobbies",e.get_hobbies();break;case e.manager.permission.sports:e.page="sports",e.get_sports();break;case e.manager.permission.managers:e.page="managers",e.get_managers();break;case e.manager.permission.competitions:e.page="competitions",e.get_competitions();break;default:n.path("/manager/signin")}},function(t){console.error(t.data)})}]),angular.module("MuscleMan").controller("ManagerSignInCtrl",["$scope","$location","Manager",function(t,e,n){t.cred={login:"",password:""},t.signin=function(){t.options.loading=!0,n.signin(t.cred,function(n){t.options.loading=!1,t.options.manager=n.data,e.path("/manager/"+t.options.manager._id)},function(e){t.options.loading=!1,console.error(e.data)})}}]),angular.module("MuscleMan").controller("OptionsCtrl",["$scope","MSG","Upload","User","LS","$vk",function(t,e,n,o,r,i){t.active_page="profile",t.cred={password:"",confirmPassword:""},t.currentYear=(new Date).getFullYear(),o.get(function(e){t.options.user=e.data,r.set("user",e.data)},function(t){e.err(t.data)}),t.unlink=function(n){o.unlink(n,function(e){t.options.user.social[n]=void 0,t.options.user.tokens[n]=void 0},function(t){e.err(t.data)})},t.upload_photo=function(e){return console.log(e),t.options.loading=!0,t.fileName=e.name,e?void n.upload({url:"/photo/new",data:{file:e}}).then(function(e){console.log("$scope.options.user:",t.options.user),console.log("res.data.image:",e.data.image),t.options.user.avatar=e.data.image,t.options.loading=!1,t.fileName=null,t.user_save()}):void(t.options.loading=!1)},t.request_permissions=function(){return"Notification"in window?void("denied"!==Notification.permission&&Notification.requestPermission(function(t){if("granted"===t){new Notification("Отлично! Вы разрешили нам уведомлять вас о новых событиях!")}"denied"===t&&e.info("Вы не сможете получать уведомления о новых событиях...")})):void e.err("Ваш браузер не поддерживает уведомления...")},t.load_countries=function(){i.get_countries(function(e){t.countries=e.data},function(t){e.err(t.data)})},t.load_cities=function(){i.get_cities({country_id:t.university?t.university.country_id:t.workplace?t.workplace.country_id:t.achievement.country_id},function(e){t.cities=e.data},function(t){e.err(t.data)})},t.load_universities=function(){i.get_universities({city_id:t.university.city_id,country_id:t.university.country_id},function(e){t.universities=e.data},function(t){e.err(t.data)})},t.load_faculties=function(){i.get_faculties({university_id:t.university.university_id},function(e){t.faculties=e.data},function(t){e.err(t.data)})},t.load_chairs=function(){i.get_chairs({faculty_id:t.university.faculty_id},function(e){t.chairs=e.data},function(t){e.err(t.data)})},t.add_university=function(){t.load_countries(),t.university={city_id:"",country_id:"",university_id:"",faculty_id:"",chair_id:"",city:"",country:"",university:"",faculty:"",chair:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},t.save_university=function(){return t.university.year_end&&t.university.year_start>t.university.year_end?void e.err("Год начала не может быть больше года окончания"):void o.add_university(t.university,function(e){t.options.user.universities.push(t.university),t.university=null},function(t){e.err(t.data)})},t.rm_university=function(n,r){o.rm_university(n,function(e){t.options.user.universities.splice(r,1)},function(t){e.err(t.data)})},t.add_workplace=function(){t.load_countries(),t.workplace={city:"",country:"",city_id:"",country_id:"",company:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},t.save_workplace=function(){return t.workplace.year_end&&t.workplace.year_start>t.workplace.year_end?void e.err("Год начала не может быть больше года окончания"):void o.add_workplace(t.workplace,function(e){t.options.user.workplaces.push(t.workplace),t.workplace=null},function(t){e.err(t.data)})},t.rm_workplace=function(n,r){o.rm_workplace(n,function(e){t.options.user.workplaces.splice(r,1)},function(t){e.err(t.data)})},t.add_achievement=function(){t.load_countries(),t.achievement={city:"",country:"",city_id:"",country_id:"",title:"",place:"",comment:"",year:+(new Date).getFullYear()}},t.save_achievement=function(){o.add_achievement(t.achievement,function(e){t.options.user.achievements.push(t.achievement),t.achievement=null},function(t){e.err(t.data)})},t.rm_achievement=function(n,r){o.rm_achievement(n,function(e){t.options.user.achievements.splice(r,1)},function(t){e.err(t.data)})},t.add_hobbie=function(){o.get_hobbies(function(e){t.hobbies=e.data,t.hobbie={}},function(t){e.err(t.data)})},t.save_hobbie=function(){o.add_hobbie(t.hobbie,function(e){t.options.user.hobbies.push(t.hobbie),t.hobbie=null},function(t){e.err(t.data)})},t.rm_hobbie=function(n,r){o.rm_hobbie(n,function(e){t.options.user.hobbies.splice(r,1)},function(t){e.err(t.data)})},t.add_sport=function(){o.get_sports(function(e){t.sports=e.data,t.sport={}},function(t){e.err(t.data)})},t.save_sport=function(){o.add_sport({sport:t.sport},function(e){t.options.user.sports.push(t.sport),t.sport=null},function(t){e.err(t.data)})},t.rm_sport=function(n,r){o.rm_sport({sport:n},function(e){t.options.user.sports.splice(r,1)},function(t){e.err(t.data)})},t.changepwd=function(){o.changepwd(t.cred,function(t){e.ok("Пароль успешно изменён!")},function(t){e.err(t.data.map(function(t){return t.msg}).join("\n\r"))})},t.user_save=function(){t.$emit("user_save"),e.ok("Сохранено успешно!")}}]),angular.module("MuscleMan").controller("PhotosCtrl",["$scope","$routeParams","socket","Upload","Photo","Album","MSG",function(t,e,n,o,r,i,a){t.photos=[],t.options.userid=e.id,t.albums=[],t.layer={editedAlbum:null,editedPhoto:null},t.gallery={current:null},t.turn_left=function(){0==t.gallery.current?t.gallery.current=t.photos.length:t.gallery.current--},t.turn_right=function(){t.gallery.current==t.photos.length-1?t.gallery.current=0:t.gallery.current++},i.get(e.id,function(e){t.albums=e.data},function(t){console.error(t.data)}),r.get(e.id,function(n){t.photos=n.data,"all"!==e.photoid&&t.photos.map(function(n,o){n._id===e.photoid&&(t.gallery.current=o)})},function(t){console.error(t.data)}),t.set_avatar=function(e){t.options.user.avatar=e.image,t.$emit("user_save")},t.create_album=function(){a.custom({type:"input",closeOnConfirm:!1,showCancelButton:!0,cancelButtonText:"Отмена",inputPlaceholder:"Название",text:"Введите название альбома",title:"Название"},function(e){e&&i.create(e,function(e){a.ok("Альбом создан!"),t.albums.push(e.data)},function(t){a.err(t.data),console.error(t.data)})})},t.edit_photo=function(e){r.edit(e,function(e){t.photos=t.photos.map(function(e){return e._id===t.layer.editedPhoto._id&&(e._id=t.layer.editedPhoto._id),e}),t.layer.editedPhoto=null,a.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},t.like=function(e,n){var o=e.likes.indexOf(t.options.user._id);o===-1?r.add_like(e,function(e){t.photos[n].likes.push(t.options.user._id)},function(t){console.error(t.data)}):r.remove_like(e,function(e){t.photos[n].likes.splice(o,1)},function(t){console.error(t.data)})},t.add_comment=function(o){var i={date:Date.now(),name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname,_id:t.photos[t.gallery.current]._id};r.add_comment(i,function(r){t.gallery.comment="",t.photos[o].comments.push(i),e.id!==t.options.user._id&&(i.target=e.id,n.emit("photo:comment",i))},function(t){console.error(t.data)})},t.remove_comment=function(e,n){r.remove_comment({comment:n,_id:t.photos[t.gallery.current]._id},function(o){t.photos[e].comments=t.photos[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===n)})},function(t){console.error(t.data)})},t.edit_album=function(e){i.set_title(e,function(e){t.albums=t.albums.map(function(e){return e._id===t.layer.editedAlbum._id&&(e._id=t.layer.editedAlbum._id),e}),t.layer.editedAlbum=null,a.ok("Нименование альбома успешно изменено!")},function(t){console.error(t.data)})},t.delete_album=function(e){i["delete"](e,function(n){t.albums=t.albums.filter(function(t){return t._id!==e})},function(t){console.error(t.data)})},t.delete_photo=function(e){t.options.loading=!0,r["delete"](e,function(n){t.photos=t.photos.filter(function(t){return t._id!==e}),t.options.loading=!1},function(e){t.options.loading=!1,console.error(e.data)})},t.upload_files=function(e){if(t.options.loading=!0,e&&e.length)for(var n=0;n<e.length;n++)!function(n){o.upload({url:"/photo/new",data:{file:e[n]}}).then(function(o){t.photos.push(o.data),!(n<e.length)&&(t.options.loading=!1)})}(n)}}]),angular.module("MuscleMan").controller("SearchCtrl",["$scope","User",function(t,e){t.search={},t.users=[],t.find_users=function(){t.search.fio&&(t.search.name=t.search.fio.split(" ")[0],t.search.surname=t.search.fio.split(" ")[1]),
e.search(t.search,function(e){t.users=e.data},function(t){console.error(t.data)})}}]),angular.module("MuscleMan").controller("SignInCtrl",["$scope","$location","socket","User","MSG","LS",function(t,e,n,o,r,i){t.cred={mail:"",pass:""},t.signin=function(){t.cred.mail.$error||(t.options.loading=!0,o.signin(t.cred,function(o){console.log(o.data),i.set("user",o.data),t.options.loading=!1,t.options.user=o.data,e.path("/user/"+t.options.user._id),n.emit("user:online",{id:t.options.user._id})},function(e){t.options.loading=!1,r.err(e.data)}))}}]),angular.module("MuscleMan").controller("SignUpCtrl",["$scope","$location","socket","User","MSG","LS",function(t,e,n,o,r,i){t.cred={mail:"",pass:""},t.signup=function(){t.cred.mail.$error||(t.options.loading=!0,o.signup(t.cred,function(o){i.set("user",o.data),t.options.loading=!1,t.options.user=o.data,e.path("/options"),n.emit("user:online",{id:t.options.user._id})},function(t){r.err(t.data.map(function(t){return t.msg}).join("\n\r"))}))}}]),angular.module("MuscleMan").controller("UserCtrl",["$scope","$location","$routeParams","socket","User","MSG","Topic","Photo","Video","Dialog","Upload",function(t,e,n,o,r,i,a,s,c,u,l){t.user={},t.photos=[],t.topics=[],t.gallery={current_photo:null,current_video:null,add_image:null},t.escape_pressed=function(t){var e=27;return console.log("escape pressed"),t.keyCode===e},t.last_seen=function(){return moment(t.user.lastOnline).fromNow()},!t.options.user&&e.path("/signin"),r.load(n.id,function(e){t.user=e.data,t.rating=0,t.user.marks&&(t.user.marks.map(function(e){t.rating+=e.mark}),t.rating=Math.round(t.rating/t.user.marks.length*100)/100)},function(t){console.error(t.data)}),s.get(n.id,function(e){t.photos=e.data},function(t){console.error(t.data)}),c.get(n.id,function(e){t.videos=e.data},function(t){console.error(t.data)}),a.get(n.id,function(e){t.topics=e.data},function(t){console.error(t.data)}),t.in_fav=function(){return t.options.user.favs.indexOf(t.user._id)>=0},t.fav=function(){t.in_fav(t.user._id)?t.options.user.favs=t.options.user.favs.filter(function(e){return e!==t.user._id}):t.options.user.favs.push(t.user._id),t.user_save()},t.is_marked=function(){return t.user.marks.filter(function(e){return e.userid===t.options.user._id}).length},t.mark=function(e){var o=function(){t.rating=0,t.user.marks.map(function(e){t.rating+=e.mark}),t.rating=Math.round(t.rating/t.user.marks.length*100)/100};t.is_marked()?r.rm_mark({id:n.id},function(e){t.user.marks=t.user.marks.filter(function(e){return e.userid!==t.options.user._id}),o()},function(t){i.err(t.data)}):r.add_mark({id:n.id,mark:e},function(n){t.user.marks.push({userid:t.options.user._id,mark:e}),o()},function(t){i.err(t.data)})},t.get_age=function(t){var e=moment(),t=moment(t);return e.diff(t,"years")},t.birth_date=function(t){return moment(t).format("DD.MM.YYYY")},t.set_current_photo=function(e){t.gallery.current_photo=e},t.turn_photo_left=function(){0===t.gallery.current_photo?t.gallery.current_photo=t.photos.length:t.gallery.current_photo--},t.turn_photo_right=function(){t.gallery.current_photo==t.photos.length-1?t.gallery.current_photo=0:t.gallery.current_photo++},t.include_video=function(t,e){switch(t){case"vimeo":return $sce.trustAsResourceUrl("https://player.vimeo.com/video/"+e+"?title=0&byline=0&portrait=0");case"youtube":return $sce.trustAsResourceUrl("https://www.youtube.com/embed/"+e+"?wmode=transparent")}},t.set_current_video=function(e){t.gallery.current_video=e},t.turn_video_left=function(){0===t.gallery.current_video?t.gallery.current_video=t.videos.length:t.gallery.current_video--},t.turn_video_right=function(){t.gallery.current_video==t.videos.length-1?t.gallery.current_video=0:t.gallery.current_video++},t.user_save=function(){t.$emit("user_save")},t.send_message=function(e){t.$emit("new_message",e)},t.add_image_to_topic=function(e){var n=t.topic.images.indexOf(e);n===-1?t.topic.images.push(e):t.topic.images.splice(n,1)},t.add_video_to_topic=function(e){var n=-1;t.topic.videos.map(function(t,o){t._id===e._id&&(n=o)}),n===-1?t.topic.videos.push(e):t.topic.videos.splice(n,1)},t.add_topic=function(){t.topic={text:"",images:[],videos:[],comment:""}},t.new_topic=function(){a["new"](t.topic,function(e){t.topics.push(e.data),t.topic={text:"",images:[],comment:""}},function(t){console.error(t.data)})},t.del_topic=function(e){a.del(t.topics[e]._id,function(n){t.topics.splice(e,1)},function(t){console.error(t.data)})},t.upload_files=function(e){if(t.options.loading=!0,e&&e.length)for(var n=0;n<e.length;n++)!function(n){l.upload({url:"/photo/new",data:{file:e[n]}}).then(function(o){t.photos.push(o.data),!(n<e.length)&&(t.options.loading=!1)})}(n)},t.add_comment=function(e){var r={date:Date.now(),_id:t.photos[e]._id,name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname};s.add_comment(r,function(i){t.gallery.comment="",t.photos[e].comments.push(r),n.id!==t.options.user._id&&(r.target=n.id,o.emit("photo:comment",r))},function(t){console.error(t.data)})},t.remove_comment=function(e,n){s.remove_comment({comment:n,_id:t.photos[t.gallery.current]._id},function(o){t.photos[e].comments=t.photos[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===n)})},function(t){console.error(t.data)})},t.add_topic_comment=function(e){var r={date:Date.now(),comment:t.topic.comment,_id:t.topics[e]._id,name:t.options.user.name,userid:t.options.user._id,avatar:t.options.user.avatar,surname:t.options.user.surname};a.add_comment(r,function(i){t.topic.comment="",t.topics[e].comments.push(r),n.id!==t.options.user._id&&(r.target=n.id,o.emit("topic:comment",r))},function(t){console.error(t.data)})},t.remove_topic_comment=function(e,n){a.remove_comment({comment:n,_id:t.topics[e]._id},function(o){t.topics[e].comments=t.topics[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===n)})},function(t){console.error(t.data)})},t.write_message=function(){i.custom({title:"Новое сообщение!",text:"Введите текст сообщения",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(n){if(n){var o={addressee:{id:t.user._id,avatar:t.user.avatar,fio:t.user.name+" "+t.user.surname},message:{text:n,t:Date.now(),uid:t.options.user._id}},r={message:n,target:t.user._id,avatar:t.options.user.avatar,fio:t.options.user.name+" "+t.options.user.surname};u.check(t.user._id,function(n){u.add_message(n.data._id,{addressee:t.user._id,message:o.message},function(n){t.send_message(r),e.path("/dialogs")},function(t){console.error(t.data)})},function(n){u.create(o,function(n){t.send_message(r),e.path("/dialogs")},function(t){console.error(t.data)})})}else swal.showInputError("Введите хоть что-нибудь...")})},t.user_save=function(){t.$emit("user_save")}}]),angular.module("MuscleMan").controller("VideosCtrl",["$sce","$http","$scope","$routeParams","Video","socket","MSG",function(t,e,n,o,r,i,a){n.videos=[],n.layer={addVideo:null,editedVideo:null},n.gallery={current:null},n.options.userid=o.id,r.get(o.id,function(t){n.videos=t.data,"all"!==o.videoid&&n.videos.map(function(t,e){t._id===o.videoid&&(n.gallery.current=e)})},function(t){console.error(t.data)}),n.include_video=function(e,n){switch(e){case"vimeo":return t.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return t.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},n.turn_left=function(){0==n.gallery.current?n.gallery.current=$scopvide.length:n.gallery.current--},n.turn_right=function(){n.gallery.current==n.videos.length-1?n.gallery.current=0:n.gallery.current++},n.add_video=function(){var t={title:n.layer.addVideo.title},o=n.layer.addVideo.link.trim();switch(!0){case 0===o.indexOf("https://www.youtube.com/watch?v="):t.type="youtube",t.link=o.split("https://www.youtube.com/watch?v=")[1];break;case 0===o.indexOf("https://www.youtu.be/"):t.type="youtube",t.link=o.split("https://www.youtu.be/")[1];break;case 0===o.indexOf("https://vimeo.com/"):t.type="vimeo",t.link=o.split("https://vimeo.com/")[1];break;default:return void a.err("Даннный тип видеохостинга пока не поддерживается!")}"vimeo"===t.type?e.get("https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/"+t.link).then(function(e){t.thumbnail=e.data.thumbnail_url,r.add(t,function(t){n.videos.push(t.data),n.layer.addVideo=null},function(t){console.error(t.data)})},function(t){console.error(t.data)}):(t.thumbnail="//img.youtube.com/vi/"+t.link+"/0.jpg",r.add(t,function(t){n.videos.push(t.data),n.layer.addVideo=null},function(t){console.error(t.data)}))},n.edit_video=function(t){r.edit(t,function(t){n.videos=n.videos.map(function(t){return t._id===n.layer.editedVideo._id&&(t._id=n.layer.editedVideo._id),t}),n.layer.editedvideo=null,a.ok("Настройки фото успешно изменены!")},function(t){console.error(t.data)})},n.delete_video=function(t){r["delete"](n.videos[t]._id,function(e){n.videos.splice(t,1)},function(t){console.error(t.data)})},n.i_like_it=function(t){return t.indexOf(n.options.user._id)!==-1},n.like=function(t,e){var o=t.likes.indexOf(n.options.user._id);o===-1?r.add_like(t,function(t){n.videos[e].likes.push(n.options.user._id)},function(t){console.error(t.data)}):r.remove_like(t,function(t){n.videos[e].likes.splice(o,1)},function(t){console.error(t.data)})},n.add_comment=function(t){var e={date:Date.now(),name:n.options.user.name,userid:n.options.user._id,comment:n.gallery.comment,avatar:n.options.user.avatar,surname:n.options.user.surname,_id:n.videos[n.gallery.current]._id};r.add_comment(e,function(r){n.gallery.comment="",n.videos[t].comments.push(e),o.id!==n.options.user._id&&(e.target=o.id,i.emit("video:comment",e))},function(t){console.error(t.data)})},n.remove_comment=function(t,e){r.remove_comment({comment:e,_id:n.videos[n.gallery.current]._id},function(o){n.videos[t].comments=n.videos[t].comments.filter(function(t){return!(t.userid===n.options.user._id&&t.comment===e)})},function(t){console.error(t.data)})}}]);