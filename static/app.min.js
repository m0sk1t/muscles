angular.module("MuscleMan",["ngLocale","ui.calendar","ngFileUpload","ngRoute","720kb.datepicker","froala","Services"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"tpl/main.tpl",controller:"MainCtrl"}).when("/manager/signin",{templateUrl:"tpl/manager_signin.tpl",controller:"ManagerSignInCtrl"}).when("/manage/user/:id",{templateUrl:"tpl/manage_user.tpl",controller:"ManageUserCtrl"}).when("/manage/article/:id",{templateUrl:"tpl/manage_article.tpl",controller:"ManageArticleCtrl"}).when("/manage/contest/:id",{templateUrl:"tpl/manage_contest.tpl",controller:"ManageContestCtrl"}).when("/manage/competition/:id",{templateUrl:"tpl/manage_competition.tpl",controller:"ManageCompetitionCtrl"}).when("/manager/:id",{templateUrl:"tpl/manager.tpl",controller:"ManagerCtrl"}).when("/signup",{templateUrl:"tpl/signup.tpl",controller:"SignUpCtrl"}).when("/signin",{templateUrl:"tpl/signin.tpl",controller:"SignInCtrl"}).when("/user/:userid/album/:id",{templateUrl:"tpl/album.tpl",controller:"AlbumCtrl"}).when("/hobbies",{templateUrl:"tpl/hobbies.tpl",controller:"HobbiesCtrl"}).when("/articles",{templateUrl:"tpl/articles.tpl",controller:"ArticlesCtrl"}).when("/article/:id",{templateUrl:"tpl/article.tpl",controller:"ArticleCtrl"}).when("/competitions",{templateUrl:"tpl/competitions.tpl",controller:"CompetitionsCtrl"}).when("/competition/:id",{templateUrl:"tpl/competition.tpl",controller:"CompetitionCtrl"}).when("/contests",{templateUrl:"tpl/contests.tpl",controller:"ContestsCtrl"}).when("/contest/:id",{templateUrl:"tpl/contest.tpl",controller:"ContestCtrl"}).when("/dialogs",{templateUrl:"tpl/dialogs.tpl",controller:"DialogsCtrl"}).when("/favs",{templateUrl:"tpl/favs.tpl",controller:"FavsCtrl"}).when("/user/:id/photos/:photoid",{templateUrl:"tpl/photos.tpl",controller:"PhotosCtrl"}).when("/user/:id/videos/:videoid",{templateUrl:"tpl/videos.tpl",controller:"VideosCtrl"}).when("/options",{templateUrl:"tpl/options.tpl",controller:"OptionsCtrl"}).when("/search",{templateUrl:"tpl/search.tpl",controller:"SearchCtrl"}).when("/user/:id",{templateUrl:"tpl/user.tpl",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(e){console.log("App loaded!")}]),angular.module("Services",[]).factory("User",["$http",function(e){return{get:function(t,n){return e.get("/user").then(t,n)},get_favs:function(t,n){return e.get("/favs").then(t,n)},get_hobbies:function(t,n){return e.get("/hobbies").then(t,n)},get_sports:function(t,n){return e.get("/sports").then(t,n)},get_contest:function(t,n,o){return e.get("/contest/"+t).then(n,o)},add_contest_participant:function(t,n,o){return e.put("/contest/"+t+"/add_participant").then(n,o)},add_paid_like:function(t,n,o,r){return e.put("/contest/"+t+"/add_paid_like/"+n).then(o,r)},add_free_like:function(t,n,o,r){return e.put("/contest/"+t+"/add_free_like/"+n).then(o,r)},rm_contest_participant:function(t,n,o){return e.put("/contest/"+t+"/rm_participant").then(n,o)},get_competition:function(t,n,o){return e.get("/competition/"+t).then(n,o)},add_mark:function(t,n,o){return e.put("/user/add_mark/"+t.id,t).then(n,o)},rm_mark:function(t,n,o){return e.put("/user/rm_mark/"+t.id,t).then(n,o)},add_university:function(t,n,o){return e.put("/user/add_university",t).then(n,o)},rm_university:function(t,n,o){return e.put("/user/rm_university",t).then(n,o)},add_workplace:function(t,n,o){return e.put("/user/add_workplace",t).then(n,o)},rm_workplace:function(t,n,o){return e.put("/user/rm_workplace",t).then(n,o)},add_achievement:function(t,n,o){return e.put("/user/add_achievement",t).then(n,o)},rm_achievement:function(t,n,o){return e.put("/user/rm_achievement",t).then(n,o)},add_hobbie:function(t,n,o){return e.put("/user/add_hobbie",t).then(n,o)},rm_hobbie:function(t,n,o){return e.put("/user/rm_hobbie",t).then(n,o)},add_sport:function(t,n,o){return e.put("/user/add_sport",t).then(n,o)},rm_sport:function(t,n,o){return e.put("/user/rm_sport",t).then(n,o)},load:function(t,n,o){return e.get("/user/"+t).then(n,o)},set:function(t,n,o){return e.put("/user",t).then(n,o)},signup:function(t,n,o){return e.post("/signup",t).then(n,o)},signin:function(t,n,o){return e.post("/auth/local",t).then(n,o)},changepwd:function(t,n,o){return e.put("/changepwd",t).then(n,o)},unlink:function(t,n,o){return e.put("/unlink/"+t).then(n,o)},search:function(t,n,o){return e.post("/user/search",t).then(n,o)}}}]).factory("Manager",["$http",function(e){return{all:function(t,n){return e.get("/manager/all").then(t,n)},get:function(t,n,o){return e.get("/manager/"+t).then(n,o)},signin:function(t,n,o){return e.post("/manager/signin",t).then(n,o)},create:function(t,n,o){return e.post("/manager/new",t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/manager/"+t).then(n,o)},set_permission:function(t,n,o,r){return e.put("/manager/"+t,n).then(o,r)},create_article:function(t,n){return e.post("/manage/article/new",{}).then(t,n)},create_contest:function(t,n){return e.post("/manage/contest/new",{}).then(t,n)},create_competition:function(t,n){return e.post("/manage/competition/new",{}).then(t,n)},create_hobbie:function(t,n,o){return e.post("/manage/hobbie/new",t).then(n,o)},create_sport:function(t,n,o){return e.post("/manage/sport/new",t).then(n,o)},update_article:function(t,n,o,r){return e.put("/manage/article/"+t,n).then(o,r)},update_contest:function(t,n,o,r){return e.put("/manage/contest/"+t,n).then(o,r)},update_competition:function(t,n,o,r){return e.put("/manage/competition/"+t,n).then(o,r)},update_hobbie:function(t,n,o,r){return e.put("/manage/hobbie/"+t,n).then(o,r)},update_sport:function(t,n,o,r){return e.put("/manage/sport/"+t,n).then(o,r)},update_user:function(t,n,o,r){return e.put("/manage/user/"+t,n).then(o,r)},get_article:function(t,n,o){return e.get("/manage/article/"+t).then(n,o)},get_contest:function(t,n,o){return e.get("/manage/contest/"+t).then(n,o)},get_competition:function(t,n,o){return e.get("/manage/competition/"+t).then(n,o)},get_articles:function(t,n,o){return e.get("/manage/articles/"+t).then(n,o)},get_contests:function(t,n,o){return e.get("/manage/contests/"+t).then(n,o)},get_competitions:function(t,n,o){return e.get("/manage/competitions/"+t).then(n,o)},get_hobbies:function(t,n){return e.get("/hobbies").then(t,n)},get_sports:function(t,n){return e.get("/sports").then(t,n)},get_photos:function(t,n,o){return e.get("/manage/photos/"+t).then(n,o)},get_users:function(t,n,o){return e.get("/manage/users/"+t).then(n,o)},get_videos:function(t,n,o){return e.get("/manage/videos/"+t).then(n,o)},get_topics:function(t,n,o){return e.get("/manage/topics/"+t).then(n,o)},delete_article:function(t,n,o){return e["delete"]("/manage/article/"+t).then(n,o)},delete_competition:function(t,n,o){return e["delete"]("/manage/competition/"+t).then(n,o)},delete_contest:function(t,n,o){return e["delete"]("/manage/contest/"+t).then(n,o)},delete_hobbie:function(t,n,o){return e["delete"]("/manage/hobbie/"+t).then(n,o)},delete_sport:function(t,n,o){return e["delete"]("/manage/sport/"+t).then(n,o)},delete_photo:function(t,n,o){return e["delete"]("/manage/photo/"+t).then(n,o)},delete_video:function(t,n,o){return e["delete"]("/manage/video/"+t).then(n,o)},delete_user:function(t,n,o){return e["delete"]("/manage/user/"+t).then(n,o)},delete_topic:function(t,n,o){return e["delete"]("/manage/topic/"+t).then(n,o)}}}]).factory("Dialog",["$http",function(e){return{get:function(t,n){return e.get("/dialog/all").then(t,n)},check:function(t,n,o){return e.get("/checkdlg/"+t).then(n,o)},create:function(t,n,o){return e.post("/dialog",t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/dialog/"+t).then(n,o)},add_message:function(t,n,o,r){return e.put("/dialog/"+t,n).then(o,r)}}}]).factory("$vk",["$http","$q",function(e,t){return{status:function(){var e=t.defer();return VK.Auth.getLoginStatus(function(t){t?e.resolve(t):e.reject("response error")}),e.promise},login:function(){var e=t.defer();return VK.Auth.login(function(t){t?e.resolve(t):e.reject("response error")}),e.promise},call:function(e,n){var o=t.defer();return VK.Api.call(e,n,function(e){e?o.resolve(e):o.reject("response error")}),o.promise},get_countries:function(t,n){return e.post("vk/database.getCountries",{}).then(t,n)},get_cities:function(t,n,o){return t.count=333,e.post("vk/database.getCities",t).then(n,o)},get_universities:function(t,n,o){return e.post("vk/database.getUniversities",t).then(n,o)},get_faculties:function(t,n,o){return e.post("vk/database.getFaculties",t).then(n,o)},get_chairs:function(t,n,o){return e.post("vk/database.getChairs",t).then(n,o)}}}]).factory("Topic",["$http",function(e){return{get:function(t,n,o){return e.get("/topic/"+t).then(n,o)},"new":function(t,n,o){return e.post("/topic/new",t).then(n,o)},del:function(t,n,o){return e["delete"]("/topic/"+t).then(n,o)},edit:function(t,n,o){return e.put("/topic/"+t._id,t).then(n,o)},add_like:function(t,n,o){return e.put("/topic/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/topic/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/topic/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/topic/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Photo",["$http",function(e){return{get:function(t,n,o){return e.get("/photo/"+t).then(n,o)},edit:function(t,n,o){return e.put("/photo/"+t._id,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/photo/"+t).then(n,o)},add_like:function(t,n,o){return e.put("/photo/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/photo/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/photo/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/photo/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Video",["$http",function(e){return{get:function(t,n,o){return e.get("/video/"+t).then(n,o)},add:function(t,n,o){return e.post("/video/new",t).then(n,o)},edit:function(t,n,o){return e.put("/video/"+t._id,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/video/"+t).then(n,o)},add_like:function(t,n,o){return e.put("/video/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/video/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/video/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/video/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Album",["$http",function(e){return{get:function(t,n,o){return e.get("/album/"+t).then(n,o)},get_one:function(t,n,o){return e.get("/single_album/"+t).then(n,o)},create:function(t,n,o){return e.post("/album/new",{title:t}).then(n,o)},set_title:function(t,n,o){return e.put("/album/"+t._id,t).then(n,o)},add_photo:function(t,n,o){return e.put("/album/"+t._id+"/add_photo/"+t.photoid,t).then(n,o)},remove_photo:function(t,n,o){return e.put("/album/"+t._id+"/remove_photo/"+t.photoid,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/album/"+t).then(n,o)}}}]).factory("MSG",function(){return{ok:function(e){swal("OK!",e)},info:function(e){swal("Info!",e,"info")},warn:function(e){swal("Warning!",e,"warning")},err:function(e){swal("Error!",e,"error")},custom:function(e,t){swal(e,t)}}}).factory("LS",function(){return{get:function(e){try{var e=localStorage.getItem(e);return e?JSON.parse(e):null}catch(t){return console.error(t),null}},set:function(e,t){try{var n=t?JSON.stringify(t):"";return localStorage.setItem(e,n),!0}catch(o){return localStorage.clear(),console.error(o),!1}}}}).factory("notify",function(){var e=new Audio("alarm.mp3");return{play:function(){e.play()}}}).factory("socket",["$rootScope",function(e){var t=io();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,r){t.emit(n,o,function(){var n=arguments;e.$apply(function(){r&&r.apply(t,n)})})}}}]),angular.module("MuscleMan").controller("AlbumCtrl",["$scope","$routeParams","Photo","Album",function(e,t,n,o){e.album={},e.photos=[],e.gallery={current:null},e.turnLeft=function(){0==e.gallery.current?e.gallery.current=e.photos.length:e.gallery.current--},e.turnRight=function(){e.gallery.current==e.photos.length-1?e.gallery.current=0:e.gallery.current++},n.get(t.userid,function(n){e.photos=n.data.filter(function(e){return e.album===t.id})},function(e){console.error(e.data)}),o.get_one(t.id,function(t){e.album=t.data},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("ArticleCtrl",["$scope",function(e){e.article={}}]),angular.module("MuscleMan").controller("ArticlesCtrl",["$scope",function(e){e.articles=[]}]),angular.module("MuscleMan").controller("CompetitionCtrl",["$scope","$routeParams","User",function(e,t,n){e.competition={},n.get_competition(t.id,function(t){e.competition=t.data},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("CompetitionsCtrl",["$scope","User","uiCalendarConfig",function(e,t,n){e.calendarOptions={eventClick:function(e,t,n){location.hash="#/competition/"+e._id}},e.change_view=function(e,t){n.calendars[t].fullCalendar("changeView",e)},e.eventSources={url:"/competition/all"}}]),angular.module("MuscleMan").controller("ContestCtrl",["$scope","$routeParams","User",function(e,t,n){var o=t.id;e.contest={},n.get_contest(o,function(t){e.contest=t.data},function(e){console.error(e.data)}),e.expired=function(){return moment(e.contest.dateParticipate).diff(Date.now(),"days")},e.count_free_likes=function(){var t=0;return e.contest.participants.map(function(e){t+=e.likes.free.length}),t},e.count_paid_likes=function(){var t=0;return e.contest.participants.map(function(e){t+=e.likes.paid.length}),t},e.count_new_participants=function(){var t=moment.now();return e.contest.participants.filter(function(e){return 1===moment(e.pDate).diff(t,"days")}).length},e.add_paid_like=function(t){n.add_paid_like(o,t,function(t){e.contest=t.data},function(e){console.error(e.data)})},e.add_free_like=function(t){n.add_free_like(o,t,function(t){e.contest=t.data},function(e){console.error(e.data)})},e.participate=function(){var t=e.contest.participants.indexOf(e.options.user._id);t===-1?n.add_contest_participant(o,function(t){e.contest=t.data},function(e){console.error(e.data)}):n.rm_contest_participant(o,function(n){e.contest.participants.splice(t,1)},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("ContestsCtrl",["$scope","User",function(e,t){e.contests=[],t.get_contest("all",function(t){e.contests=t.data},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("DialogsCtrl",["$scope","Dialog",function(e,t){e.dialog="",e.message="",e.dialogs=[],e.messages=[],t.get(function(t){e.dialogs=t.data},function(e){console.error(e.data)}),e.set_messages=function(t,n){e.messages=t.messages,e.dialogIndex=n,e.dialog=t._id,e.message=""},e.add_message=function(){var n={t:Date.now(),text:e.message,uid:e.options.user._id},o=e.dialogs[e.dialogIndex].users.filter(function(t){return t.id!==e.options.user._id})[0];t.add_message(e.dialog,{message:n,addressee:o},function(t){e.$emit("new_message",{target:o.id,message:n.text,avatar:e.options.user.avatar,fio:e.options.user.name+" "+e.options.user.surname}),e.dialogs[e.dialogIndex].messages.push(n),e.message=""},function(e){console.error(e.data)})},e.delete_dialog=function(n,o){t["delete"](n._id,function(t){e.messages=[],e.dialogs.splice(o,1)},function(e){console.error(e.data)})},e.with_user=function(t){var n=t.users.filter(function(t){return t.id!==e.options.user._id})[0];return n?n.fio:"пользователь покинул беседу..."}}]),angular.module("MuscleMan").controller("FavsCtrl",["$scope","User",function(e,t){e.favs=[],t.get_favs(function(t){e.favs=t.data},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("HobbiesCtrl",["$scope",function(e){}]),angular.module("MuscleMan").controller("MainCtrl",["$scope","socket","User","LS","notify",function(e,t,n,o,r){e.options={user:o.get("user")||0},e.getloc=function(){return"#/"===location.hash},e.options.user&&t.emit("user:online",{id:e.options.user._id}),t.on("new:message",function(t){if(console.log("new:message"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вас новое сообщение!",{icon:t.avatar,body:t.fio+" сказал"+t.text});r.play(),setTimeout(n.close.bind(n),3e3)}}),t.on("photo:comment",function(t){if(console.log("photo:comment"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вашего фото новый комментарий!",{icon:t.avatar,body:t.name+" "+t.surname+" сказал"+t.comment});r.play(),setTimeout(n.close.bind(n),3e3)}}),t.on("video:comment",function(t){if(console.log("video:comment"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вашего видео новый комментарий!",{icon:t.avatar,body:t.name+" "+t.surname+" сказал"+t.comment});r.play(),setTimeout(n.close.bind(n),3e3)}}),e.getloc=function(){return"#/"===location.hash},!!e.options.user&&n.get(function(t){e.options.user=t.data,o.set("user",t.data)},function(e){location.hash="#/auth"}),e.$on("new_message",function(e,n){t.emit("new:message",n)}),e.$on("user_save",function(){n.set(e.options.user,function(t){o.set("user",e.options.user),console.log("User saved!")},function(e){console.error(e.data)})})}]),angular.module("MuscleMan").controller("ManageArticleCtrl",["$scope","$location","Manager","$routeParams",function(e,t,n,o){e.froalaOptions={language:"ru",imageInsertButtons:"imageByURL",placeholderText:"Введите текст новости",imageAllowedTypes:["jpeg","jpg","png"],toolbarButtons:["bold","italic","underline","strikeThrough","fontSize","|","emoticons","color","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","quote","insertHR","-","insertLink","insertImage"]},n.get_article(o.id,function(t){e.article=t.data},function(e){console.error(e.data)}),e.update_article=function(){n.update_article(o.id,e.article,function(e){window.history.back()},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("ManageCompetitionCtrl",["$scope","$location","Manager","$routeParams",function(e,t,n,o){n.get_competition(o.id,function(t){e.competition=t.data},function(e){console.error(e.data)}),e.update_competition=function(){n.update_competition(o.id,e.competition,function(e){window.history.back()},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("ManageContestCtrl",["$scope","$location","Manager","$routeParams",function(e,t,n,o){var r=o.id;n.get_contest(r,function(t){e.contest=t.data},function(e){console.error(e.data)}),e.del=function(t){e.contest.participants.splice(t,1),e.update_contest()},e.update_contest=function(){n.update_contest(r,e.contest,function(e){alert("Saved!")},function(e){alert("Error! "+e.data)})}}]),angular.module("MuscleMan").controller("ManageUserCtrl",["$scope","User","Manager","$routeParams",function(e,t,n,o){t.load(o.id,function(t){e.user=t.data},function(e){console.error(e.data)}),e.del_wp=function(t){e.user.workplaces.splice(t,1),e.update_user()},e.del_ac=function(t){e.user.achievements.splice(t,1),e.update_user()},e.del_un=function(t){e.user.universities.splice(t,1),e.update_user()},e.update_user=function(){n.update_user(o.id,e.user,function(t){e.user=t.data},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("ManagerCtrl",["$sce","$scope","$location","Manager","$routeParams",function(e,t,n,o,r){t.items={cred:null,sport:null,hobbie:null},t.creDate={users:new Date,photos:new Date,videos:new Date,topics:new Date,articles:new Date,contests:new Date,competitions:new Date},t.article_html=function(t){return e.trustAsHtml(t)},t.add_manager=function(){t.items.cred={login:"",password:""}},t.create_manager=function(){o.create(t.items.cred,function(e){t.items.cred=null,t.managers.push(e.data)},function(e){console.error(e.data)})},t.delete_manager=function(e,n){o["delete"](e,function(e){t.managers.splice(n,1)},function(e){console.error(e.data)})},t.get_hobbies=function(){o.get_hobbies(function(e){t.hobbies=e.data},function(e){console.error(e.data)})},t.add_hobbie=function(){t.items.hobbie={type:0,item:""}},t.create_hobbie=function(){o.create_hobbie(t.items.hobbie,function(e){t.items.hobbie=null,t.hobbies.push(e.data)},function(e){console.error(e.data)})},t.delete_hobbie=function(e,n){o.delete_hobbie(e,function(e){t.hobbies.splice(n,1)},function(e){console.error(e.data)})},t.get_sports=function(){o.get_sports(function(e){t.sports=e.data},function(e){console.error(e.data)})},t.add_sport=function(){t.items.sport={sex:1,sport:""}},t.create_sport=function(){o.create_sport(t.items.sport,function(e){t.items.sport=null,t.sports.push(e.data)},function(e){console.error(e.data)})},t.delete_sport=function(e,n){o.delete_sport(e,function(e){t.sports.splice(n,1)},function(e){console.error(e.data)})},t.get_managers=function(){o.all(function(e){t.managers=e.data},function(e){console.error(e.data)})},t.set_permission=function(e,n){o.set_permission(e,t.managers[n].permission,function(e){console.log("permission saved")},function(e){console.error(e.data)})},t.get_photos=function(){o.get_photos(t.creDate.photos,function(e){t.photos=e.data},function(e){console.error(e.data)})},t.delete_photo=function(e,n){o.delete_photo(e,function(e){t.photos.splice(n,1)},function(e){console.error(e.data)})},t.get_videos=function(){o.get_videos(t.creDate.videos,function(e){t.videos=e.data},function(e){console.error(e.data)})},t.delete_video=function(e,n){o.delete_video(e,function(e){t.videos.splice(n,1)},function(e){console.error(e.data)})},t.get_topics=function(){o.get_topics(t.creDate.topics,function(e){t.topics=e.data},function(e){console.error(e.data)})},t.delete_topic=function(e,n){o.delete_topic(e,function(e){t.topics.splice(n,1)},function(e){console.error(e.data)})},t.get_users=function(){o.get_users(t.creDate.users,function(e){t.users=e.data},function(e){console.error(e.data)})},t.delete_user=function(e,n){o.delete_user(e,function(e){t.users.splice(n,1)},function(e){console.error(e.data)})},t.get_articles=function(){o.get_articles(t.creDate.articles,function(e){t.articles=e.data},function(e){console.error(e.data)})},t.create_article=function(){o.create_article(function(e){n.path("/manage/article/"+e.data._id)},function(e){console.error(e.data)})},t.delete_article=function(e,n){o.delete_article(e,function(e){t.articles.splice(n,1)},function(e){console.error(e.data)})},t.create_contest=function(){o.create_contest(function(e){n.path("/manage/contest/"+e.data._id)},function(e){console.error(e.data)})},t.get_contests=function(){o.get_contests(t.creDate.contests,function(e){t.contests=e.data},function(e){console.error(e.data)})},t.delete_contest=function(e,n){o.delete_contest(e,function(e){t.contests.splice(n,1)},function(e){console.error(e.data)})},t.create_competition=function(){o.create_competition(function(e){n.path("/manage/competition/"+e.data._id)},function(e){console.error(e.data)})},t.get_competitions=function(){o.get_competitions(t.creDate.competitions,function(e){t.competitions=e.data},function(e){console.error(e.data)})},t.delete_competition=function(e,n){o.delete_competition(e,function(e){t.competitions.splice(n,1)},function(e){console.error(e.data)})},o.get(r.id,function(e){switch(t.manager=e.data,!0){case t.manager.permission.articles:t.page="article",t.get_articles();break;case t.manager.permission.users:t.page="users",t.get_users();break;case t.manager.permission.photos:t.page="photos",t.get_photos();break;case t.manager.permission.videos:t.page="videos",t.get_videos();break;case t.manager.permission.topics:t.page="topics",t.get_topics();break;case t.manager.permission.contests:t.page="contests",t.get_contests();break;case t.manager.permission.hobbies:t.page="hobbies",t.get_hobbies();break;case t.manager.permission.sports:t.page="sports",t.get_sports();break;case t.manager.permission.managers:t.page="managers",t.get_managers();break;case t.manager.permission.competitions:t.page="competitions",t.get_competitions();break;default:n.path("/manager/signin")}},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("ManagerSignInCtrl",["$scope","$location","Manager",function(e,t,n){e.cred={login:"",password:""},e.signin=function(){e.options.loading=!0,n.signin(e.cred,function(n){e.options.loading=!1,e.options.manager=n.data,t.path("/manager/"+e.options.manager._id)},function(t){e.options.loading=!1,console.error(t.data)})}}]),angular.module("MuscleMan").controller("OptionsCtrl",["$scope","MSG","Upload","User","LS","$vk",function(e,t,n,o,r,i){e.active_page="profile",e.cred={password:"",confirmPassword:""},e.currentYear=(new Date).getFullYear(),o.get(function(t){e.options.user=t.data,r.set("user",t.data)},function(e){t.err(e.data)}),e.unlink=function(n){o.unlink(n,function(t){e.options.user.social[n]=void 0,e.options.user.tokens[n]=void 0},function(e){t.err(e.data)})},e.upload_photo=function(t){return console.log(t),e.options.loading=!0,e.fileName=t.name,t?void n.upload({url:"/photo/new",data:{file:t}}).then(function(t){console.log("$scope.options.user:",e.options.user),console.log("res.data.image:",t.data.image),e.options.user.avatar=t.data.image,e.options.loading=!1,e.fileName=null,e.user_save()}):void(e.options.loading=!1)},e.request_permissions=function(){return"Notification"in window?void("denied"!==Notification.permission&&Notification.requestPermission(function(e){if("granted"===e){new Notification("Отлично! Вы разрешили нам уведомлять вас о новых событиях!")}"denied"===e&&t.info("Вы не сможете получать уведомления о новых событиях...")})):void t.err("Ваш браузер не поддерживает уведомления...")},e.load_countries=function(){i.get_countries(function(t){e.countries=t.data},function(e){t.err(e.data)})},e.load_cities=function(){i.get_cities({country_id:e.university?e.university.country_id:e.workplace?e.workplace.country_id:e.achievement?e.achievement.country_id:e.options.user.location_country.id},function(t){e.cities=t.data},function(e){t.err(e.data)})},e.load_universities=function(){i.get_universities({city_id:e.university.city_id,country_id:e.university.country_id},function(t){e.universities=t.data},function(e){t.err(e.data)})},e.load_faculties=function(){i.get_faculties({university_id:e.university.university_id},function(t){e.faculties=t.data},function(e){t.err(e.data)})},e.load_chairs=function(){i.get_chairs({faculty_id:e.university.faculty_id},function(t){e.chairs=t.data},function(e){t.err(e.data)})},e.add_university=function(){e.load_countries(),e.university={city_id:"",country_id:"",university_id:"",faculty_id:"",chair_id:"",city:"",country:"",university:"",faculty:"",chair:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},e.save_university=function(){return e.university.year_end&&e.university.year_start>e.university.year_end?void t.err("Год начала не может быть больше года окончания"):void o.add_university(e.university,function(t){e.options.user.universities.push(e.university),e.university=null},function(e){t.err(e.data)})},e.rm_university=function(n,r){o.rm_university(n,function(t){e.options.user.universities.splice(r,1)},function(e){t.err(e.data)})},e.add_workplace=function(){e.load_countries(),e.workplace={city:"",country:"",city_id:"",country_id:"",company:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},e.save_workplace=function(){return e.workplace.year_end&&e.workplace.year_start>e.workplace.year_end?void t.err("Год начала не может быть больше года окончания"):void o.add_workplace(e.workplace,function(t){e.options.user.workplaces.push(e.workplace),e.workplace=null},function(e){t.err(e.data)})},e.rm_workplace=function(n,r){o.rm_workplace(n,function(t){e.options.user.workplaces.splice(r,1)},function(e){t.err(e.data)})},e.add_achievement=function(){e.load_countries(),e.achievement={city:"",country:"",city_id:"",country_id:"",title:"",place:"",comment:"",year:+(new Date).getFullYear()}},e.save_achievement=function(){o.add_achievement(e.achievement,function(t){e.options.user.achievements.push(e.achievement),e.achievement=null},function(e){t.err(e.data)})},e.rm_achievement=function(n,r){o.rm_achievement(n,function(t){e.options.user.achievements.splice(r,1)},function(e){t.err(e.data)})},e.add_hobbie=function(){o.get_hobbies(function(t){e.hobbies=t.data,e.hobbie={}},function(e){t.err(e.data)})},e.save_hobbie=function(){o.add_hobbie(e.hobbie,function(t){e.options.user.hobbies.push(e.hobbie),e.hobbie=null},function(e){t.err(e.data)})},e.rm_hobbie=function(n,r){o.rm_hobbie(n,function(t){e.options.user.hobbies.splice(r,1)},function(e){t.err(e.data)})},e.add_sport=function(){o.get_sports(function(t){e.sports=t.data,e.sport={}},function(e){t.err(e.data)})},e.save_sport=function(){o.add_sport({sport:e.sport},function(t){e.options.user.sports.push(e.sport),e.sport=null},function(e){t.err(e.data)})},e.rm_sport=function(n,r){o.rm_sport({sport:n},function(t){e.options.user.sports.splice(r,1)},function(e){t.err(e.data)})},e.changepwd=function(){o.changepwd(e.cred,function(e){t.ok("Пароль успешно изменён!")},function(e){t.err(e.data.map(function(e){return e.msg}).join("\n\r"))})},e.user_save=function(){e.$emit("user_save"),t.ok("Сохранено успешно!")}}]),angular.module("MuscleMan").controller("PhotosCtrl",["$scope","$routeParams","socket","Upload","Photo","Album","MSG",function(e,t,n,o,r,i,a){e.photos=[],e.options.userid=t.id,e.albums=[],e.layer={editedAlbum:null,editedPhoto:null},e.gallery={current:null},e.turn_left=function(){0==e.gallery.current?e.gallery.current=e.photos.length:e.gallery.current--},e.turn_right=function(){e.gallery.current==e.photos.length-1?e.gallery.current=0:e.gallery.current++},i.get(t.id,function(t){e.albums=t.data},function(e){console.error(e.data)}),r.get(t.id,function(n){e.photos=n.data,"all"!==t.photoid&&e.photos.map(function(n,o){n._id===t.photoid&&(e.gallery.current=o)})},function(e){console.error(e.data)}),e.set_avatar=function(t){e.options.user.avatar=t.image,e.$emit("user_save")},e.create_album=function(){a.custom({type:"input",closeOnConfirm:!1,showCancelButton:!0,cancelButtonText:"Отмена",inputPlaceholder:"Название",text:"Введите название альбома",title:"Название"},function(t){t&&i.create(t,function(t){a.ok("Альбом создан!"),e.albums.push(t.data)},function(e){a.err(e.data),console.error(e.data)})})},e.edit_photo=function(t){r.edit(t,function(t){e.photos=e.photos.map(function(t){return t._id===e.layer.editedPhoto._id&&(t._id=e.layer.editedPhoto._id),t}),e.layer.editedPhoto=null,a.ok("Настройки фото успешно изменены!")},function(e){console.error(e.data)})},e.like=function(t,n){var o=t.likes.indexOf(e.options.user._id);o===-1?r.add_like(t,function(t){e.photos[n].likes.push(e.options.user._id)},function(e){console.error(e.data)}):r.remove_like(t,function(t){e.photos[n].likes.splice(o,1)},function(e){console.error(e.data)})},e.add_comment=function(o){var i={date:Date.now(),name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname,_id:e.photos[e.gallery.current]._id};r.add_comment(i,function(r){e.gallery.comment="",e.photos[o].comments.push(i),t.id!==e.options.user._id&&(i.target=t.id,n.emit("photo:comment",i))},function(e){console.error(e.data)})},e.remove_comment=function(t,n){r.remove_comment({comment:n,_id:e.photos[e.gallery.current]._id},function(o){e.photos[t].comments=e.photos[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===n)})},function(e){console.error(e.data)})},e.edit_album=function(t){i.set_title(t,function(t){e.albums=e.albums.map(function(t){return t._id===e.layer.editedAlbum._id&&(t._id=e.layer.editedAlbum._id),t}),e.layer.editedAlbum=null,a.ok("Нименование альбома успешно изменено!")},function(e){console.error(e.data)})},e.delete_album=function(t){i["delete"](t,function(n){e.albums=e.albums.filter(function(e){
return e._id!==t})},function(e){console.error(e.data)})},e.delete_photo=function(t){e.options.loading=!0,r["delete"](t,function(n){e.photos=e.photos.filter(function(e){return e._id!==t}),e.options.loading=!1},function(t){e.options.loading=!1,console.error(t.data)})},e.upload_files=function(t){if(e.options.loading=!0,t&&t.length)for(var n=0;n<t.length;n++)!function(n){o.upload({url:"/photo/new",data:{file:t[n]}}).then(function(o){e.photos.push(o.data),!(n<t.length)&&(e.options.loading=!1)})}(n)}}]),angular.module("MuscleMan").controller("SearchCtrl",["$scope","User",function(e,t){e.search={},e.users=[],e.find_users=function(){e.search.fio&&(e.search.name=e.search.fio.split(" ")[0],e.search.surname=e.search.fio.split(" ")[1]),t.search(e.search,function(t){e.users=t.data},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("SignInCtrl",["$scope","$location","socket","User","MSG","LS",function(e,t,n,o,r,i){e.cred={mail:"",pass:""},e.signin=function(){e.cred.mail.$error||(e.options.loading=!0,o.signin(e.cred,function(o){console.log(o.data),i.set("user",o.data),e.options.loading=!1,e.options.user=o.data,t.path("/user/"+e.options.user._id),n.emit("user:online",{id:e.options.user._id})},function(t){e.options.loading=!1,r.err(t.data)}))}}]),angular.module("MuscleMan").controller("SignUpCtrl",["$scope","$location","socket","User","MSG","LS",function(e,t,n,o,r,i){e.cred={mail:"",pass:""},e.signup=function(){e.cred.mail.$error||(e.options.loading=!0,o.signup(e.cred,function(o){i.set("user",o.data),e.options.loading=!1,e.options.user=o.data,t.path("/options"),n.emit("user:online",{id:e.options.user._id})},function(e){r.err(e.data.map(function(e){return e.msg}).join("\n\r"))}))}}]),angular.module("MuscleMan").controller("UserCtrl",["$sce","$scope","$location","$routeParams","socket","User","MSG","Topic","Photo","Video","Dialog","Upload",function(e,t,n,o,r,i,a,c,s,u,l,d){t.user={},t.photos=[],t.topics=[],t.gallery={current_photo:null,current_video:null,add_image:null},t.escape_pressed=function(e){var t=27;return console.log("escape pressed"),e.keyCode===t},t.last_seen=function(){return moment(t.user.lastOnline).fromNow()},!t.options.user&&n.path("/signin"),i.load(o.id,function(e){t.user=e.data,t.rating=0,t.user.marks&&(t.user.marks.map(function(e){t.rating+=e.mark}),t.rating=Math.round(t.rating/t.user.marks.length*100)/100)},function(e){console.error(e.data)}),s.get(o.id,function(e){t.photos=e.data},function(e){console.error(e.data)}),u.get(o.id,function(e){t.videos=e.data},function(e){console.error(e.data)}),c.get(o.id,function(e){t.topics=e.data},function(e){console.error(e.data)}),t.in_fav=function(){return t.options.user.favs.indexOf(t.user._id)>=0},t.fav=function(){t.in_fav(t.user._id)?t.options.user.favs=t.options.user.favs.filter(function(e){return e!==t.user._id}):t.options.user.favs.push(t.user._id),t.user_save()},t.is_marked=function(){return t.user.marks.filter(function(e){return e.userid===t.options.user._id}).length},t.mark=function(e){var n=function(){t.rating=0,t.user.marks.map(function(e){t.rating+=e.mark}),t.rating=Math.round(t.rating/t.user.marks.length*100)/100};t.is_marked()?i.rm_mark({id:o.id},function(e){t.user.marks=t.user.marks.filter(function(e){return e.userid!==t.options.user._id}),n()},function(e){a.err(e.data)}):i.add_mark({id:o.id,mark:e},function(o){t.user.marks.push({userid:t.options.user._id,mark:e}),n()},function(e){a.err(e.data)})},t.get_age=function(e){var t=moment(),e=moment(e);return t.diff(e,"years")},t.birth_date=function(e){return moment(e).format("DD.MM.YYYY")},t.set_current_photo=function(e){t.gallery.current_photo=e},t.turn_photo_left=function(){0===t.gallery.current_photo?t.gallery.current_photo=t.photos.length:t.gallery.current_photo--},t.turn_photo_right=function(){t.gallery.current_photo==t.photos.length-1?t.gallery.current_photo=0:t.gallery.current_photo++},t.include_video=function(t,n){switch(t){case"vimeo":return e.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return e.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},t.set_current_video=function(e){t.gallery.current_video=e},t.turn_video_left=function(){0===t.gallery.current_video?t.gallery.current_video=t.videos.length:t.gallery.current_video--},t.turn_video_right=function(){t.gallery.current_video==t.videos.length-1?t.gallery.current_video=0:t.gallery.current_video++},t.user_save=function(){t.$emit("user_save")},t.send_message=function(e){t.$emit("new_message",e)},t.add_image_to_topic=function(e){var n=t.topic.images.indexOf(e);n===-1?t.topic.images.push(e):t.topic.images.splice(n,1)},t.add_video_to_topic=function(e){var n=-1;t.topic.videos.map(function(t,o){t._id===e._id&&(n=o)}),n===-1?t.topic.videos.push(e):t.topic.videos.splice(n,1)},t.add_topic=function(){t.topic={text:"",images:[],videos:[],comment:""}},t.new_topic=function(){c["new"](t.topic,function(e){t.topics.push(e.data),t.topic={text:"",images:[],comment:""}},function(e){console.error(e.data)})},t.del_topic=function(e){c.del(t.topics[e]._id,function(n){t.topics.splice(e,1)},function(e){console.error(e.data)})},t.upload_files=function(e){if(t.options.loading=!0,e&&e.length)for(var n=0;n<e.length;n++)!function(n){d.upload({url:"/photo/new",data:{file:e[n]}}).then(function(o){t.photos.push(o.data),!(n<e.length)&&(t.options.loading=!1)})}(n)},t.add_comment=function(e){var n={date:Date.now(),_id:t.photos[e]._id,name:t.options.user.name,userid:t.options.user._id,comment:t.gallery.comment,avatar:t.options.user.avatar,surname:t.options.user.surname};s.add_comment(n,function(i){t.gallery.comment="",t.photos[e].comments.push(n),o.id!==t.options.user._id&&(n.target=o.id,r.emit("photo:comment",n))},function(e){console.error(e.data)})},t.remove_comment=function(e,n){s.remove_comment({comment:n,_id:t.photos[t.gallery.current]._id},function(o){t.photos[e].comments=t.photos[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===n)})},function(e){console.error(e.data)})},t.add_topic_comment=function(e){var n={date:Date.now(),comment:t.topic.comment,_id:t.topics[e]._id,name:t.options.user.name,userid:t.options.user._id,avatar:t.options.user.avatar,surname:t.options.user.surname};c.add_comment(n,function(i){t.topic.comment="",t.topics[e].comments.push(n),o.id!==t.options.user._id&&(n.target=o.id,r.emit("topic:comment",n))},function(e){console.error(e.data)})},t.remove_topic_comment=function(e,n){c.remove_comment({comment:n,_id:t.topics[e]._id},function(o){t.topics[e].comments=t.topics[e].comments.filter(function(e){return!(e.userid===t.options.user._id&&e.comment===n)})},function(e){console.error(e.data)})},t.write_message=function(){a.custom({title:"Новое сообщение!",text:"Введите текст сообщения",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(e){if(e){var o={addressee:{id:t.user._id,avatar:t.user.avatar,fio:t.user.name+" "+t.user.surname},message:{text:e,t:Date.now(),uid:t.options.user._id}},r={message:e,target:t.user._id,avatar:t.options.user.avatar,fio:t.options.user.name+" "+t.options.user.surname};l.check(t.user._id,function(e){l.add_message(e.data._id,{addressee:t.user._id,message:o.message},function(e){t.send_message(r),n.path("/dialogs")},function(e){console.error(e.data)})},function(e){l.create(o,function(e){t.send_message(r),n.path("/dialogs")},function(e){console.error(e.data)})})}else swal.showInputError("Введите хоть что-нибудь...")})},t.user_save=function(){t.$emit("user_save")}}]),angular.module("MuscleMan").controller("VideosCtrl",["$sce","$http","$scope","$routeParams","Video","socket","MSG",function(e,t,n,o,r,i,a){n.videos=[],n.layer={addVideo:null,editedVideo:null},n.gallery={current:null},n.options.userid=o.id,r.get(o.id,function(e){n.videos=e.data,"all"!==o.videoid&&n.videos.map(function(e,t){e._id===o.videoid&&(n.gallery.current=t)})},function(e){console.error(e.data)}),n.include_video=function(t,n){switch(t){case"vimeo":return e.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return e.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},n.turn_left=function(){0==n.gallery.current?n.gallery.current=$scopvide.length:n.gallery.current--},n.turn_right=function(){n.gallery.current==n.videos.length-1?n.gallery.current=0:n.gallery.current++},n.add_video=function(){var e={title:n.layer.addVideo.title},o=n.layer.addVideo.link.trim();switch(!0){case 0===o.indexOf("https://www.youtube.com/watch?v="):e.type="youtube",e.link=o.split("https://www.youtube.com/watch?v=")[1];break;case 0===o.indexOf("https://www.youtu.be/"):e.type="youtube",e.link=o.split("https://www.youtu.be/")[1];break;case 0===o.indexOf("https://vimeo.com/"):e.type="vimeo",e.link=o.split("https://vimeo.com/")[1];break;default:return void a.err("Даннный тип видеохостинга пока не поддерживается!")}"vimeo"===e.type?t.get("https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/"+e.link).then(function(t){e.thumbnail=t.data.thumbnail_url,r.add(e,function(e){n.videos.push(e.data),n.layer.addVideo=null},function(e){console.error(e.data)})},function(e){console.error(e.data)}):(e.thumbnail="//img.youtube.com/vi/"+e.link+"/0.jpg",r.add(e,function(e){n.videos.push(e.data),n.layer.addVideo=null},function(e){console.error(e.data)}))},n.edit_video=function(e){r.edit(e,function(e){n.videos=n.videos.map(function(e){return e._id===n.layer.editedVideo._id&&(e._id=n.layer.editedVideo._id),e}),n.layer.editedvideo=null,a.ok("Настройки фото успешно изменены!")},function(e){console.error(e.data)})},n.delete_video=function(e){r["delete"](n.videos[e]._id,function(t){n.videos.splice(e,1)},function(e){console.error(e.data)})},n.i_like_it=function(e){return e.indexOf(n.options.user._id)!==-1},n.like=function(e,t){var o=e.likes.indexOf(n.options.user._id);o===-1?r.add_like(e,function(e){n.videos[t].likes.push(n.options.user._id)},function(e){console.error(e.data)}):r.remove_like(e,function(e){n.videos[t].likes.splice(o,1)},function(e){console.error(e.data)})},n.add_comment=function(e){var t={date:Date.now(),name:n.options.user.name,userid:n.options.user._id,comment:n.gallery.comment,avatar:n.options.user.avatar,surname:n.options.user.surname,_id:n.videos[n.gallery.current]._id};r.add_comment(t,function(r){n.gallery.comment="",n.videos[e].comments.push(t),o.id!==n.options.user._id&&(t.target=o.id,i.emit("video:comment",t))},function(e){console.error(e.data)})},n.remove_comment=function(e,t){r.remove_comment({comment:t,_id:n.videos[n.gallery.current]._id},function(o){n.videos[e].comments=n.videos[e].comments.filter(function(e){return!(e.userid===n.options.user._id&&e.comment===t)})},function(e){console.error(e.data)})}}]);