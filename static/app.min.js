angular.module("MuscleMan",["ngLocale","ngFileUpload","ngRoute","720kb.datepicker","froala","Services"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"tpl/main.tpl",controller:"MainCtrl"}).when("/manager/signin",{templateUrl:"tpl/manager_signin.tpl",controller:"ManagerSignInCtrl"}).when("/manage/article/:id",{templateUrl:"tpl/manage_article.tpl",controller:"ManageArticleCtrl"}).when("/manager/:id",{templateUrl:"tpl/manager.tpl",controller:"ManagerCtrl"}).when("/signup",{templateUrl:"tpl/signup.tpl",controller:"SignUpCtrl"}).when("/signin",{templateUrl:"tpl/signin.tpl",controller:"SignInCtrl"}).when("/user/:userid/album/:id",{templateUrl:"tpl/album.tpl",controller:"AlbumCtrl"}).when("/hobbies",{templateUrl:"tpl/hobbies.tpl",controller:"HobbiesCtrl"}).when("/articles",{templateUrl:"tpl/articles.tpl",controller:"ArticlesCtrl"}).when("/article/:id",{templateUrl:"tpl/article.tpl",controller:"ArticleCtrl"}).when("/competitions",{templateUrl:"tpl/competitions.tpl",controller:"CompetitionsCtrl"}).when("/competition/:id",{templateUrl:"tpl/competition.tpl",controller:"CompetitionCtrl"}).when("/contests",{templateUrl:"tpl/contests.tpl",controller:"ContestsCtrl"}).when("/contest/:id",{templateUrl:"tpl/contest.tpl",controller:"ContestCtrl"}).when("/dialogs",{templateUrl:"tpl/dialogs.tpl",controller:"DialogsCtrl"}).when("/favs",{templateUrl:"tpl/favs.tpl",controller:"FavsCtrl"}).when("/user/:id/photos/:photoid",{templateUrl:"tpl/photos.tpl",controller:"PhotosCtrl"}).when("/user/:id/videos/:videoid",{templateUrl:"tpl/videos.tpl",controller:"VideosCtrl"}).when("/options",{templateUrl:"tpl/options.tpl",controller:"OptionsCtrl"}).when("/search",{templateUrl:"tpl/search.tpl",controller:"SearchCtrl"}).when("/status",{templateUrl:"tpl/status.tpl",controller:"StatusCtrl"}).when("/user/:id",{templateUrl:"tpl/user.tpl",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(e){console.log("App loaded!")}]),angular.module("Services",[]).factory("User",["$http",function(e){return{get:function(t,n){return e.get("/user").then(t,n)},add_university:function(t,n,o){return e.put("/user/add_university",t).then(n,o)},rm_university:function(t,n,o){return e.put("/user/rm_university",t).then(n,o)},add_workplace:function(t,n,o){return e.put("/user/add_workplace",t).then(n,o)},rm_workplace:function(t,n,o){return e.put("/user/rm_workplace",t).then(n,o)},add_achievement:function(t,n,o){return e.put("/user/add_achievement",t).then(n,o)},rm_achievement:function(t,n,o){return e.put("/user/rm_achievement",t).then(n,o)},load:function(t,n,o){return e.get("/user/"+t).then(n,o)},set:function(t,n,o){return e.put("/user",t).then(n,o)},signup:function(t,n,o){return e.post("/signup",t).then(n,o)},signin:function(t,n,o){return e.post("/auth/local",t).then(n,o)},unlink:function(t,n,o){return e.put("/unlink/"+t).then(n,o)},find_users:function(t,n,o){return e.post("/user/search",t).then(n,o)}}}]).factory("Manager",["$http",function(e){return{all:function(t,n){return e.get("/manager/all").then(t,n)},get:function(t,n,o){return e.get("/manager/"+t).then(n,o)},signin:function(t,n,o){return e.post("/manager/signin",t).then(n,o)},create:function(t,n,o){return e.post("/manager/new",t).then(n,o)},get_article:function(t,n,o){return e.get("/manage/article/"+t).then(n,o)},create_article:function(t,n,o){return e.post("/manage/article/new",t).then(n,o)},update_article:function(t,n,o,i){return e.put("/manage/article/"+t,n).then(o,i)},"delete":function(t,n,o){return e["delete"]("/manager/"+t).then(n,o)},set_permission:function(t,n,o,i){return e.put("/manager/"+t,n).then(o,i)},get_users:function(t,n){return e.get("/manage/users").then(t,n)},get_hobbies:function(t,n){return e.get("/manage/hobbies").then(t,n)},get_photos:function(t,n,o){return e.get("/manage/photos/"+t).then(n,o)},get_videos:function(t,n){return e.get("/manage/videos").then(t,n)},get_topics:function(t,n){return e.get("/manage/topics").then(t,n)},get_articles:function(t,n){return e.get("/manage/articles").then(t,n)},get_contests:function(t,n){return e.get("/manage/contests").then(t,n)},get_competitions:function(t,n){return e.get("/manage/competitions").then(t,n)},delete_user:function(t,n,o){return e["delete"]("/manage/user/"+t).then(n,o)},delete_hobbie:function(t,n,o){return e["delete"]("/manage/hobbie/"+t).then(n,o)},delete_photo:function(t,n,o){return e["delete"]("/manage/photo/"+t).then(n,o)},delete_video:function(t,n,o){return e["delete"]("/manage/video/"+t).then(n,o)},delete_topic:function(t,n,o){return e["delete"]("/manage/topic/"+t).then(n,o)},delete_article:function(t,n,o){return e["delete"]("/manage/article/"+t).then(n,o)},delete_contest:function(t,n,o){return e["delete"]("/manage/contest/"+t).then(n,o)},delete_competition:function(t,n,o){return e["delete"]("/manage/competition/"+t).then(n,o)}}}]).factory("Dialog",["$http",function(e){return{get:function(t,n){return e.get("/dialog/all").then(t,n)},check:function(t,n,o){return e.get("/checkdlg/"+t).then(n,o)},create:function(t,n,o){return e.post("/dialog",t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/dialog/"+t).then(n,o)},add_message:function(t,n,o,i){return e.put("/dialog/"+t,n).then(o,i)}}}]).factory("$vk",["$http","$q",function(e,t){return{status:function(){var e=t.defer();return VK.Auth.getLoginStatus(function(t){t?e.resolve(t):e.reject("response error")}),e.promise},login:function(){var e=t.defer();return VK.Auth.login(function(t){t?e.resolve(t):e.reject("response error")}),e.promise},call:function(e,n){var o=t.defer();return VK.Api.call(e,n,function(e){e?o.resolve(e):o.reject("response error")}),o.promise},get_countries:function(t,n){return e.post("vk/database.getCountries",{}).then(t,n)},get_cities:function(t,n,o){return t.count=333,e.post("vk/database.getCities",t).then(n,o)},get_universities:function(t,n,o){return e.post("vk/database.getUniversities",t).then(n,o)},get_faculties:function(t,n,o){return e.post("vk/database.getFaculties",t).then(n,o)},get_chairs:function(t,n,o){return e.post("vk/database.getChairs",t).then(n,o)}}}]).factory("Topic",["$http",function(e){return{get:function(t,n,o){return e.get("/topic/"+t).then(n,o)},"new":function(t,n,o){return e.post("/topic/new",t).then(n,o)},edit:function(t,n,o){return e.put("/topic/"+t._id,t).then(n,o)},add_like:function(t,n,o){return e.put("/topic/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/topic/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/topic/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/topic/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Photo",["$http",function(e){return{get:function(t,n,o){return e.get("/photo/"+t).then(n,o)},edit:function(t,n,o){return e.put("/photo/"+t._id,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/photo/"+t).then(n,o)},add_like:function(t,n,o){return e.put("/photo/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/photo/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/photo/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/photo/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Video",["$http",function(e){return{get:function(t,n,o){return e.get("/video/"+t).then(n,o)},add:function(t,n,o){return e.post("/video/new",t).then(n,o)},edit:function(t,n,o){return e.put("/video/"+t._id,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/video/"+t).then(n,o)},add_like:function(t,n,o){return e.put("/video/"+t._id+"/add_like").then(n,o)},remove_like:function(t,n,o){return e.put("/video/"+t._id+"/remove_like").then(n,o)},add_comment:function(t,n,o){return e.put("/video/"+t._id+"/add_comment",t).then(n,o)},remove_comment:function(t,n,o){return e.put("/video/"+t._id+"/remove_comment",t).then(n,o)}}}]).factory("Album",["$http",function(e){return{get:function(t,n,o){return e.get("/album/"+t).then(n,o)},get_one:function(t,n,o){return e.get("/single_album/"+t).then(n,o)},create:function(t,n,o){return e.post("/album/new",{title:t}).then(n,o)},set_title:function(t,n,o){return e.put("/album/"+t._id,t).then(n,o)},add_photo:function(t,n,o){return e.put("/album/"+t._id+"/add_photo/"+t.photoid,t).then(n,o)},remove_photo:function(t,n,o){return e.put("/album/"+t._id+"/remove_photo/"+t.photoid,t).then(n,o)},"delete":function(t,n,o){return e["delete"]("/album/"+t).then(n,o)}}}]).factory("MSG",function(){return{ok:function(e){swal("OK!",e)},info:function(e){swal("Info!",e,"info")},warn:function(e){swal("Warning!",e,"warning")},err:function(e){swal("Error!",e,"error")},custom:function(e,t){swal(e,t)}}}).factory("LS",function(){return{get:function(e){try{var e=localStorage.getItem(e);return e?JSON.parse(e):null}catch(t){return console.error(t),null}},set:function(e,t){try{var n=t?JSON.stringify(t):"";return localStorage.setItem(e,n),!0}catch(o){return localStorage.clear(),console.error(o),!1}}}}).factory("notify",function(){var e=new Audio("alarm.mp3");return{play:function(){e.play()}}}).factory("socket",["$rootScope",function(e){var t=io();return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,i){t.emit(n,o,function(){var n=arguments;e.$apply(function(){i&&i.apply(t,n)})})}}}]),angular.module("MuscleMan").controller("AlbumCtrl",["$scope","$routeParams","Photo","Album",function(e,t,n,o){e.album={},e.photos=[],e.gallery={current:null},e.turnLeft=function(){0==e.gallery.current?e.gallery.current=e.photos.length:e.gallery.current--},e.turnRight=function(){e.gallery.current==e.photos.length-1?e.gallery.current=0:e.gallery.current++},n.get(t.userid,function(n){e.photos=n.data.filter(function(e){return e.album===t.id})},function(e){console.error(e.data)}),o.get_one(t.id,function(t){e.album=t.data},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("ArticleCtrl",["$scope",function(e){e.article={}}]),angular.module("MuscleMan").controller("ArticlesCtrl",["$scope",function(e){e.articles=[]}]),angular.module("MuscleMan").controller("AuthCtrl",["$scope","$location","socket","User","MSG","LS",function(e,t,n,o,i,r){e.cred={mail:"",pass:""},e.auth=function(){e.cred.mail.$error||o.auth(e.cred,function(a){switch(e.options.loading=!1,n.emit("user:auth"),a.status){case 202:r.set("user",a.data),e.options.user=a.data,t.path("/user/"+e.options.user._id);break;default:e.cred.mail&&i.custom({type:"input",closeOnConfirm:!1,title:'Письмо отправлено на почту "'+e.cred.mail+'"!',text:"Для подтверждения почты, необходимо ввести ниже пин-код, присланный в письме",inputPlaceholder:"ПИН-КОД"},function(r){r&&o.pin({pin:r,mail:e.cred.mail},function(e){n.emit("user:auth"),t.path("/options"),i.ok("Добро пожаловать!")},function(e){switch(e.status){case 403:swal.showInputError("Неверный пин-код, осталось попыток: "+e.data.attempts);break;default:msg.err("Пин-код был введён неверно 5! раз, пожалуйста запросите заново...")}})})}},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("CompetitionCtrl",["$scope",function(e){e.competition={}}]),angular.module("MuscleMan").controller("CompetitionsCtrl",["$scope",function(e){e.competitions=[]}]),angular.module("MuscleMan").controller("ContestCtrl",["$scope",function(e){e.contest={}}]),angular.module("MuscleMan").controller("ContestsCtrl",["$scope",function(e){e.contests=[]}]),angular.module("MuscleMan").controller("DialogsCtrl",["$scope","Dialog",function(e,t){e.dialog="",e.message="",e.dialogs=[],e.messages=[],t.get(function(t){e.dialogs=t.data},function(e){console.error(e.data)}),e.set_messages=function(t,n){e.messages=t.messages,e.dialogIndex=n,e.dialog=t._id,e.message=""},e.add_message=function(){var n={t:Date.now(),text:e.message,uid:e.options.user._id},o=e.dialogs[e.dialogIndex].users.filter(function(t){return t.id!==e.options.user._id})[0];t.add_message(e.dialog,{message:n,addressee:o},function(t){e.$emit("new_message",{target:o.id,message:n.text,avatar:e.options.user.avatar,fio:e.options.user.name+" "+e.options.user.surname}),e.dialogs[e.dialogIndex].messages.push(n),e.message=""},function(e){console.error(e.data)})},e.delete_dialog=function(n,o){t["delete"](n._id,function(t){e.messages=[],e.dialogs.splice(o,1)},function(e){console.error(e.data)})},e.with_user=function(t){var n=t.users.filter(function(t){return t.id!==e.options.user._id})[0];return n?n.fio:"пользователь покинул беседу..."}}]),angular.module("MuscleMan").controller("FavsCtrl",["$scope",function(e){e.favs=[]}]),angular.module("MuscleMan").controller("HobbiesCtrl",["$scope",function(e){}]),angular.module("MuscleMan").controller("MainCtrl",["$scope","socket","User","LS","notify",function(e,t,n,o,i){e.options={user:o.get("user")||0},e.getloc=function(){return"#/"===location.hash},e.options.user&&t.emit("user:online",{id:e.options.user._id}),t.on("new:message",function(t){if(console.log("new:message"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вас новое сообщение!",{icon:t.avatar,body:t.fio+" сказал"+t.text});i.play(),setTimeout(n.close.bind(n),3e3)}}),t.on("photo:comment",function(t){if(console.log("photo:comment"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вашего фото новый комментарий!",{icon:t.avatar,body:t.name+" "+t.surname+" сказал"+t.comment});i.play(),setTimeout(n.close.bind(n),3e3)}}),t.on("video:comment",function(t){if(console.log("video:comment"),console.log(t),"denied"!==Notification.permission&&e.options.user.settings.show_notifications){var n=new Notification("У вашего видео новый комментарий!",{icon:t.avatar,body:t.name+" "+t.surname+" сказал"+t.comment});i.play(),setTimeout(n.close.bind(n),3e3)}}),e.options={user:o.get("user")||0},e.getloc=function(){return"#/"===location.hash},!!e.options.user&&n.get(function(t){e.options.user=t.data,o.set("user",t.data)},function(e){location.hash="#/auth"}),e.$on("new_message",function(e,n){t.emit("new:message",n)}),e.$on("user_save",function(){n.set(e.options.user,function(t){o.set("user",e.options.user),console.log("User saved!")},function(e){console.error(e.data)})})}]),angular.module("MuscleMan").controller("ManageArticleCtrl",["$scope","$location","Manager","$routeParams",function(e,t,n,o){e.froalaOptions={language:"ru",imageInsertButtons:"imageByURL",placeholderText:"Введите текст новости",imageAllowedTypes:["jpeg","jpg","png"],toolbarButtons:["bold","italic","underline","strikeThrough","fontSize","|","emoticons","color","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","quote","insertHR","-","insertLink","insertImage"]},n.get_article(o.id,function(t){e.article=t.data},function(e){console.error(e.data)}),e.update_article=function(){n.update_article(o.id,e.article,function(e){window.history.back()},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("ManagerCtrl",["$sce","$scope","$location","Manager","$routeParams",function(e,t,n,o,i){t.creDate={user:new Date,photo:new Date,video:new Date,topic:new Date,article:new Date,contest:new Date,competition:new Date},t.add_manager=function(){t.cred={login:"",password:""}},t.article_html=function(t){return e.trustAsHtml(t)},t.create_manager=function(){o.create(t.cred,function(e){t.cred=null,t.managers.push(e.data)},function(e){console.error(e.data)})},t.delete_manager=function(e,n){o["delete"](e,function(e){t.managers.splice(n,1)},function(e){console.error(e.data)})},t.get_managers=function(){o.all(function(e){t.managers=e.data},function(e){console.error(e.data)})},t.set_permission=function(e,n){o.set_permission(e,t.managers[n].permission,function(e){console.log("permission saved")},function(e){console.error(e.data)})},t.get_photos=function(){o.get_photos(t.creDate,function(e){t.photos=e.data,t.creDate=t.photos[0].creDate},function(e){console.error(e.data)})},t.delete_photo=function(e,n){o.delete_photo(e,function(e){t.photos.splice(n,1)},function(e){console.error(e.data)})},t.get_videos=function(){o.get_videos(t.creDate,function(e){t.videos=e.data,t.creDate=t.videos[0].creDate},function(e){console.error(e.data)})},t.delete_video=function(e,n){o.delete_video(e,function(e){t.videos.splice(n,1)},function(e){console.error(e.data)})},t.get_topics=function(){o.get_topics(t.creDate,function(e){t.topics=e.data,t.creDate=t.topics[0].creDate},function(e){console.error(e.data)})},t.delete_topic=function(e,n){o.delete_topic(e,function(e){t.topics.splice(n,1)},function(e){console.error(e.data)})},t.get_users=function(){o.get_users(function(e){t.users=e.data},function(e){console.error(e.data)})},t.delete_user=function(e,n){o.delete_user(e,function(e){t.users.splice(n,1)},function(e){console.error(e.data)})},t.get_hobbies=function(){o.get_hobbies(function(e){t.hobbies=e.data},function(e){console.error(e.data)})},t.delete_hobbie=function(e,n){o.delete_hobbie(e,function(e){t.hobbies.splice(n,1)},function(e){console.error(e.data)})},t.get_articles=function(){o.get_articles(function(e){t.articles=e.data},function(e){console.error(e.data)})},t.create_article=function(){o.create_article(t.new_article,function(e){n.path("/manage/article/"+e.data._id)},function(e){console.error(e.data)})},t.edit_article=function(e){n.path("/manage/article/"+e)},t.delete_article=function(e,n){o.delete_article(e,function(e){t.articles.splice(n,1)},function(e){console.error(e.data)})},t.get_contests=function(){o.get_contests(function(e){t.contests=e.data},function(e){console.error(e.data)})},t.delete_contest=function(e,n){o.delete_contest(e,function(e){t.contests.splice(n,1)},function(e){console.error(e.data)})},t.get_competitions=function(){o.get_competitions(function(e){t.competitions=e.data},function(e){console.error(e.data)})},t.delete_competition=function(e,n){o.delete_competition(e,function(e){t.competitions.splice(n,1)},function(e){console.error(e.data)})},o.get(i.id,function(e){switch(t.manager=e.data,!0){case t.manager.permission.articles:t.page="article",t.get_articles();break;case t.manager.permission.users:t.page="users",t.get_users();break;case t.manager.permission.photos:t.page="photos",t.get_photos();break;case t.manager.permission.videos:t.page="videos",t.get_videos();break;case t.manager.permission.topics:t.page="topics",t.get_topics();break;case t.manager.permission.contests:t.page="contests",t.get_contests();break;case t.manager.permission.hobbies:t.page="hobbies",t.get_hobbies();break;case t.manager.permission.managers:t.page="managers",t.get_managers();break;case t.manager.permission.competitions:t.page="competitions",t.get_competitions();break;default:n.path("/manager/signin")}},function(e){console.error(e.data)})}]),angular.module("MuscleMan").controller("ManagerSignInCtrl",["$scope","$location","Manager",function(e,t,n){e.cred={login:"",password:""},e.signin=function(){e.options.loading=!0,n.signin(e.cred,function(n){e.options.loading=!1,e.options.manager=n.data,t.path("/manager/"+e.options.manager._id)},function(t){e.options.loading=!1,console.error(t.data)})}}]),angular.module("MuscleMan").controller("OptionsCtrl",["$scope","MSG","Upload","User","LS","$vk",function(e,t,n,o,i,r){e.cred={old_password:"",new_password:""},o.get(function(t){e.options.user=t.data,i.set("user",t.data)},function(e){console.error(e.data)}),e.active_page="profile",e.unlink=function(t){o.unlink(t,function(n){e.options.user.social[t]=void 0,e.options.user.tokens[t]=void 0},function(e){console.error(e.data)})},e.upload_photo=function(t){return console.log(t),e.options.loading=!0,e.fileName=t.name,t?void n.upload({url:"/photo/new",data:{file:t}}).then(function(t){console.log("$scope.options.user:",e.options.user),console.log("res.data.image:",t.data.image),e.options.user.avatar=t.data.image,e.options.loading=!1,e.fileName=null,e.user_save()}):void(e.options.loading=!1)},e.request_permissions=function(){return"Notification"in window?void("denied"!==Notification.permission&&Notification.requestPermission(function(e){if("granted"===e){new Notification("Отлично! Вы разрешили нам уведомлять вас о новых событиях!")}"denied"===e&&t.info("Вы не сможете получать уведомления о новых событиях...")})):void t.err("Ваш браузер не поддерживает уведомления...")},e.load_countries=function(){r.get_countries(function(t){e.countries=t.data},function(e){console.error(e.data)})},e.load_cities=function(){r.get_cities({country_id:e.university?e.university.country_id:e.workplace?e.workplace.country_id:e.achievement.country_id},function(t){e.cities=t.data},function(e){console.error(e.data)})},e.load_universities=function(){r.get_universities({city_id:e.university.city_id,country_id:e.university.country_id},function(t){e.universities=t.data},function(e){console.error(e.data)})},e.load_faculties=function(){r.get_faculties({university_id:e.university.university_id},function(t){e.faculties=t.data},function(e){console.error(e.data)})},e.load_chairs=function(){r.get_chairs({faculty_id:e.university.faculty_id},function(t){e.chairs=t.data},function(e){console.error(e.data)})},e.add_university=function(){e.load_countries(),e.university={city_id:"",country_id:"",university_id:"",faculty_id:"",chair_id:"",city:"",country:"",university:"",faculty:"",chair:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},e.save_university=function(){o.add_university(e.university,function(t){e.options.user.universities.push(e.university),e.university=null},function(e){console.error(e.data)})},e.rm_university=function(t,n){o.rm_university(t,function(t){e.options.user.universities.splice(n,1)},function(e){console.error(e.data)})},e.add_workplace=function(){e.load_countries(),e.workplace={city:"",country:"",city_id:"",country_id:"",company:"",speciality:"",year_end:+(new Date).getFullYear(),year_start:+(new Date).getFullYear()}},e.save_workplace=function(){o.add_workplace(e.workplace,function(t){e.options.user.workplaces.push(e.workplace),e.workplace=null},function(e){console.error(e.data)})},e.rm_workplace=function(t,n){o.rm_workplace(t,function(t){e.options.user.workplaces.splice(n,1)},function(e){console.error(e.data)})},e.add_achievement=function(){e.load_countries(),e.achievement={city:"",country:"",city_id:"",country_id:"",title:"",place:"",comment:"",year:+(new Date).getFullYear()}},e.save_achievement=function(){o.add_achievement(e.achievement,function(t){e.options.user.achievements.push(e.achievement),e.achievement=null},function(e){console.error(e.data)})},e.rm_achievement=function(t,n){o.rm_achievement(t,function(t){e.options.user.achievements.splice(n,1)},function(e){console.error(e.data)})},e.user_save=function(){e.$emit("user_save")}}]),angular.module("MuscleMan").controller("PhotosCtrl",["$scope","$routeParams","socket","Upload","Photo","Album","MSG",function(e,t,n,o,i,r,a){e.photos=[],e.options.userid=t.id,e.albums=[],e.layer={editedAlbum:null,editedPhoto:null},e.gallery={current:null},e.turn_left=function(){0==e.gallery.current?e.gallery.current=e.photos.length:e.gallery.current--},e.turn_right=function(){e.gallery.current==e.photos.length-1?e.gallery.current=0:e.gallery.current++},r.get(t.id,function(t){e.albums=t.data},function(e){console.error(e.data)}),i.get(t.id,function(n){e.photos=n.data,"all"!==t.photoid&&e.photos.map(function(n,o){n._id===t.photoid&&(e.gallery.current=o)})},function(e){console.error(e.data)}),e.set_avatar=function(t){e.options.user.avatar=t.image,e.$emit("user_save")},e.create_album=function(){a.custom({type:"input",closeOnConfirm:!1,showCancelButton:!0,cancelButtonText:"Отмена",inputPlaceholder:"Название",text:"Введите название альбома",title:"Название"},function(t){t&&r.create(t,function(t){a.ok("Альбом создан!"),e.albums.push(t.data)},function(e){a.err(e.data),console.error(e.data)})})},e.edit_photo=function(t){i.edit(t,function(t){e.photos=e.photos.map(function(t){return t._id===e.layer.editedPhoto._id&&(t._id=e.layer.editedPhoto._id),t}),e.layer.editedPhoto=null,a.ok("Настройки фото успешно изменены!")},function(e){console.error(e.data)})},e.like=function(t,n){var o=t.likes.indexOf(e.options.user._id);o===-1?i.add_like(t,function(t){e.photos[n].likes.push(e.options.user._id)},function(e){console.error(e.data)}):i.remove_like(t,function(t){e.photos[n].likes.splice(o,1)},function(e){console.error(e.data)})},e.add_comment=function(o){var r={date:Date.now(),name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname,_id:e.photos[e.gallery.current]._id};i.add_comment(r,function(i){e.gallery.comment="",e.photos[o].comments.push(r),t.id!==e.options.user._id&&(r.target=t.id,n.emit("photo:comment",r))},function(e){console.error(e.data)})},e.remove_comment=function(t,n){i.remove_comment({comment:n,_id:e.photos[e.gallery.current]._id},function(o){e.photos[t].comments=e.photos[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===n)})},function(e){console.error(e.data)})},e.edit_album=function(t){r.set_title(t,function(t){e.albums=e.albums.map(function(t){return t._id===e.layer.editedAlbum._id&&(t._id=e.layer.editedAlbum._id),t}),e.layer.editedAlbum=null,a.ok("Нименование альбома успешно изменено!")},function(e){console.error(e.data)})},e.delete_album=function(t){r["delete"](t,function(n){e.albums=e.albums.filter(function(e){return e._id!==t})},function(e){console.error(e.data)})},e.delete_photo=function(t){e.options.loading=!0,i["delete"](t,function(n){e.photos=e.photos.filter(function(e){return e._id!==t}),e.options.loading=!1},function(t){e.options.loading=!1,console.error(t.data)})},e.upload_files=function(t){if(e.options.loading=!0,t&&t.length)for(var n=0;n<t.length;n++)!function(n){o.upload({url:"/photo/new",data:{file:t[n]}}).then(function(o){e.photos.push(o.data),!(n<t.length)&&(e.options.loading=!1)})}(n)}}]),angular.module("MuscleMan").controller("SearchCtrl",["$scope","User",function(e,t){e.search={},e.users=[],e.find_users=function(){e.search.fio&&(e.search.name=e.search.fio.split(" ")[0],e.search.surname=e.search.fio.split(" ")[1]),t.find_users(e.search,function(t){e.users=t.data},function(e){console.error(e.data)})}}]),angular.module("MuscleMan").controller("SignInCtrl",["$scope","$location","socket","User","MSG","LS",function(e,t,n,o,i,r){e.cred={mail:"",pass:""},e.signin=function(){e.cred.mail.$error||(e.options.loading=!0,o.signin(e.cred,function(o){console.log(o.data),r.set("user",o.data),e.options.loading=!1,e.options.user=o.data,t.path("/user/"+e.options.user._id),n.emit("user:online",{id:e.options.user._id})},function(t){e.options.loading=!1,console.error(t.data)}))}}]),angular.module("MuscleMan").controller("SignUpCtrl",["$scope","$location","socket","User","LS",function(e,t,n,o,i){e.cred={mail:"",pass:""},e.signup=function(){e.cred.mail.$error||(e.options.loading=!0,o.signup(e.cred,function(o){i.set("user",o.data),e.options.loading=!1,e.options.user=o.data,t.path("/user/"+e.options.user._id),n.emit("user:online",{id:e.options.user._id})},function(e){console.error(e.data)}))}}]),angular.module("MuscleMan").controller("StatusCtrl",["$scope",function(e){e.status={}}]),angular.module("MuscleMan").controller("UserCtrl",["$scope","$location","$routeParams","socket","User","MSG","Topic","Photo","Video","Dialog","Upload",function(e,t,n,o,i,r,a,c,s,u,l){e.user={},e.photos=[],e.topics=[],e.gallery={current:null,add_image:null},e.escape_pressed=function(e){var t=27;return console.log("escape pressed"),e.keyCode===t},e.last_seen=function(){return moment(e.user.lastOnline).fromNow()},!e.options.user&&t.path("/signin"),i.load(n.id,function(t){e.user=t.data},function(e){console.error(e.data)}),e.get_age=function(e){var t=moment(),e=moment(e);return t.diff(e,"years")},e.birth_date=function(e){return moment(e).format("DD.MM.YYYY")},e.set_current=function(t){e.gallery.current=t},e.turn_left=function(){0===e.gallery.current?e.gallery.current=e.photos.length:e.gallery.current--},e.turn_right=function(){e.gallery.current==e.photos.length-1?e.gallery.current=0:e.gallery.current++},c.get(n.id,function(t){e.photos=t.data},function(e){console.error(e.data)}),a.get(n.id,function(t){e.topics=t.data},function(e){console.error(e.data)}),e.user_save=function(){e.$emit("user_save")},e.send_message=function(t){e.$emit("new_message",t)},e.add_image_to_topic=function(t){var n=e.topic.images.indexOf(t);n===-1?e.topic.images.push(t):e.topic.images.splice(n,1)},e.add_video_to_topic=function(t){var n=-1;e.topic.videos.map(function(e,o){e._id===t._id&&(n=o)}),n===-1?e.topic.videos.push(t):e.topic.videos.splice(n,1)},e.add_topic=function(){e.topic={text:"",images:[],videos:[],comment:""}},e.new_topic=function(){a["new"](e.topic,function(t){e.topics.push(t.data),e.topic={text:"",images:[],comment:""}},function(e){console.error(e.data)})},e.del_topic=function(t){a.del(e.topics[t]._id,function(n){e.topics.splice(t,1)},function(e){console.error(e.data)})},e.upload_files=function(t){if(e.options.loading=!0,t&&t.length)for(var n=0;n<t.length;n++)!function(n){l.upload({url:"/photo/new",data:{file:t[n]}}).then(function(o){e.photos.push(o.data),!(n<t.length)&&(e.options.loading=!1)})}(n)},e.add_comment=function(t){var i={date:Date.now(),_id:e.photos[t]._id,name:e.options.user.name,userid:e.options.user._id,comment:e.gallery.comment,avatar:e.options.user.avatar,surname:e.options.user.surname};c.add_comment(i,function(r){e.gallery.comment="",e.photos[t].comments.push(i),n.id!==e.options.user._id&&(i.target=n.id,o.emit("photo:comment",i))},function(e){console.error(e.data)})},e.remove_comment=function(t,n){c.remove_comment({comment:n,_id:e.photos[e.gallery.current]._id},function(o){e.photos[t].comments=e.photos[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===n)})},function(e){console.error(e.data)})},e.add_topic_comment=function(t){var i={date:Date.now(),comment:e.topic.comment,_id:e.topics[t]._id,name:e.options.user.name,userid:e.options.user._id,avatar:e.options.user.avatar,surname:e.options.user.surname};a.add_comment(i,function(r){e.topic.comment="",e.topics[t].comments.push(i),n.id!==e.options.user._id&&(i.target=n.id,o.emit("topic:comment",i))},function(e){console.error(e.data)})},e.remove_topic_comment=function(t,n){a.remove_comment({comment:n,_id:e.topics[t]._id},function(o){e.topics[t].comments=e.topics[t].comments.filter(function(t){return!(t.userid===e.options.user._id&&t.comment===n)})},function(e){console.error(e.data)})},e.write_message=function(){r.custom({title:"Новое сообщение!",text:"Введите текст сообщения",type:"input",showCancelButton:!0,closeOnConfirm:!0},function(n){if(n){var o={addressee:{id:e.user._id,avatar:e.user.avatar,fio:e.user.name+" "+e.user.surname},message:{text:n,t:Date.now(),uid:e.options.user._id}},i={message:n,target:e.user._id,avatar:e.options.user.avatar,fio:e.options.user.name+" "+e.options.user.surname};u.check(e.user._id,function(n){u.add_message(n.data._id,{addressee:e.user._id,message:o.message},function(n){e.send_message(i),t.path("/dialogs")},function(e){console.error(e.data)})},function(n){u.create(o,function(n){e.send_message(i),t.path("/dialogs")},function(e){console.error(e.data)})})}else swal.showInputError("Введите хоть что-нибудь...")})},e.user_save=function(){e.$emit("user_save")}}]),angular.module("MuscleMan").controller("VideosCtrl",["$sce","$http","$scope","$routeParams","Video","socket","MSG",function(e,t,n,o,i,r,a){n.videos=[],n.layer={addVideo:null,editedVideo:null},n.gallery={current:null},n.options.userid=o.id,i.get(o.id,function(e){n.videos=e.data,"all"!==o.videoid&&n.videos.map(function(e,t){e._id===o.videoid&&(n.gallery.current=t)})},function(e){console.error(e.data)}),n.include_video=function(t,n){switch(t){case"vimeo":return e.trustAsResourceUrl("https://player.vimeo.com/video/"+n+"?title=0&byline=0&portrait=0");case"youtube":return e.trustAsResourceUrl("https://www.youtube.com/embed/"+n+"?wmode=transparent")}},n.turn_left=function(){0==n.gallery.current?n.gallery.current=$scopvide.length:n.gallery.current--;
},n.turn_right=function(){n.gallery.current==n.videos.length-1?n.gallery.current=0:n.gallery.current++},n.add_video=function(){var e={title:n.layer.addVideo.title},o=n.layer.addVideo.link.trim();switch(!0){case 0===o.indexOf("https://www.youtube.com/watch?v="):e.type="youtube",e.link=o.split("https://www.youtube.com/watch?v=")[1];break;case 0===o.indexOf("https://www.youtu.be/"):e.type="youtube",e.link=o.split("https://www.youtu.be/")[1];break;case 0===o.indexOf("https://vimeo.com/"):e.type="vimeo",e.link=o.split("https://vimeo.com/")[1];break;default:return void a.err("Даннный тип видеохостинга пока не поддерживается!")}"vimeo"===e.type?t.get("https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/"+e.link).then(function(t){e.thumbnail=t.data.thumbnail_url,i.add(e,function(e){n.videos.push(e.data),n.layer.addVideo=null},function(e){console.error(e.data)})},function(e){console.error(e.data)}):(e.thumbnail="//img.youtube.com/vi/"+e.link+"/0.jpg",i.add(e,function(e){n.videos.push(e.data),n.layer.addVideo=null},function(e){console.error(e.data)}))},n.edit_video=function(e){i.edit(e,function(e){n.videos=n.videos.map(function(e){return e._id===n.layer.editedVideo._id&&(e._id=n.layer.editedVideo._id),e}),n.layer.editedvideo=null,a.ok("Настройки фото успешно изменены!")},function(e){console.error(e.data)})},n.delete_video=function(e){i["delete"](n.videos[e]._id,function(t){n.videos.splice(e,1)},function(e){console.error(e.data)})},n.i_like_it=function(e){return e.indexOf(n.options.user._id)!==-1},n.like=function(e,t){var o=e.likes.indexOf(n.options.user._id);o===-1?i.add_like(e,function(e){n.videos[t].likes.push(n.options.user._id)},function(e){console.error(e.data)}):i.remove_like(e,function(e){n.videos[t].likes.splice(o,1)},function(e){console.error(e.data)})},n.add_comment=function(e){var t={date:Date.now(),name:n.options.user.name,userid:n.options.user._id,comment:n.gallery.comment,avatar:n.options.user.avatar,surname:n.options.user.surname,_id:n.videos[n.gallery.current]._id};i.add_comment(t,function(i){n.gallery.comment="",n.videos[e].comments.push(t),o.id!==n.options.user._id&&(t.target=o.id,r.emit("video:comment",t))},function(e){console.error(e.data)})},n.remove_comment=function(e,t){i.remove_comment({comment:t,_id:n.videos[n.gallery.current]._id},function(o){n.videos[e].comments=n.videos[e].comments.filter(function(e){return!(e.userid===n.options.user._id&&e.comment===t)})},function(e){console.error(e.data)})}}]);